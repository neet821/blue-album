# 注册功能故障排查指南

## 问题诊断步骤

### 1. 检查浏览器控制台
打开浏览器开发者工具 (F12)，查看:
- **Console 标签**: 查看 JavaScript 错误和我添加的详细日志
- **Network 标签**: 查看 HTTP 请求和响应

### 2. 查看前端日志
在浏览器控制台中,您应该能看到:
```
发送注册请求: {username: "...", email: "..."}
```

如果注册失败,会看到:
```
注册失败 - 完整错误: Error...
错误响应: {...}
错误数据: {...}
```

### 3. 常见错误及解决方案

#### 错误 1: 网络错误 (Network Error)
**症状**: `ERR_CONNECTION_REFUSED` 或 `Failed to fetch`
**原因**: 后端服务器未运行
**解决**: 
```powershell
cd d:\Laragon\laragon\www\blue-local
python -m uvicorn backend.main:app --reload --port 8000
```

#### 错误 2: CORS 错误
**症状**: `Access-Control-Allow-Origin` 相关错误
**原因**: 前端端口不在 CORS 允许列表中
**解决**: 检查 `backend/main.py` 的 CORS 配置

#### 错误 3: 数据库连接失败
**症状**: 500 错误,后端日志显示数据库连接错误
**解决**: 
```python
# 创建数据库
python -c "import pymysql; conn = pymysql.connect(host='localhost', user='root', password=''); cursor = conn.cursor(); cursor.execute('CREATE DATABASE IF NOT EXISTS blue_local_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;'); conn.commit(); cursor.close(); conn.close()"

# 创建表
python -c "import sys; sys.path.insert(0, '.'); from backend.database import engine; from backend.models import Base; Base.metadata.create_all(bind=engine); print('数据库表创建成功!')"
```

#### 错误 4: 字段验证失败
**症状**: 422 Unprocessable Entity
**原因**: 提交的数据不符合后端验证规则
**检查**:
- 用户名长度是否满足要求
- 邮箱格式是否正确
- 密码是否符合要求

#### 错误 5: 用户已存在
**症状**: 400 错误,提示 "Username already registered"
**解决**: 尝试使用不同的用户名或邮箱

### 4. 手动测试后端 API

使用以下 PowerShell 命令直接测试后端:

```powershell
# 测试注册 API
$body = @{
    username = "testuser123"
    email = "test123@example.com"
    password = "password123"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/users/register" -Method Post -Body $body -ContentType "application/json"
```

### 5. 检查数据库表是否创建

使用 HeidiSQL 或其他 MySQL 客户端连接到:
- Host: localhost
- User: root
- Password: (空)
- Database: blue_local_db

检查是否存在 `users` 和 `posts` 表。

### 6. 查看后端日志

后端终端应该显示每个 API 请求:
```
INFO:     127.0.0.1:xxxxx - "POST /api/users/register HTTP/1.1" 200 OK
```

如果看到 500 或其他错误代码,后端会显示详细的错误堆栈。

## 快速修复命令

如果需要重新开始,按顺序执行:

```powershell
# 1. 停止所有服务 (Ctrl+C)

# 2. 重新创建数据库和表
cd d:\Laragon\laragon\www\blue-local
python -c "import pymysql; conn = pymysql.connect(host='localhost', user='root', password=''); cursor = conn.cursor(); cursor.execute('DROP DATABASE IF EXISTS blue_local_db;'); cursor.execute('CREATE DATABASE blue_local_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;'); conn.commit(); cursor.close(); conn.close()"

python -c "import sys; sys.path.insert(0, '.'); from backend.database import engine; from backend.models import Base; Base.metadata.create_all(bind=engine)"

# 3. 启动后端
python -m uvicorn backend.main:app --reload --port 8000

# 4. 启动前端 (新终端)
cd frontend
node "C:\Program Files\nodejs\node_modules\npm\bin\npm-cli.js" run dev
```

## 请告诉我

1. 浏览器控制台显示什么错误?
2. Network 标签中注册请求的状态码是什么?
3. 后端终端显示什么错误(如果有)?

这些信息将帮助我精准定位问题!
