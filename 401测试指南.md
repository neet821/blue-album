# 🧪 401 自动登出测试指南

**测试时间:** 2025年10月19日  
**测试目标:** 验证 token 失效时自动跳转并提示

---

## 📋 测试前准备

### 确认修复内容
- ✅ `request.js` 拦截器已添加 401 处理
- ✅ 401 响应时调用 `authStore.logout()`
- ✅ 自动跳转到 `/login` 页面
- ✅ 显示 "登录已过期,请重新登录" 提示

---

## 🔍 测试方法 A: 手动删除 Token (推荐)

### 步骤 1: 确认已登录
1. 访问 http://localhost:5173
2. 确认处于登录状态
3. 访问 http://localhost:5173/tools/link-dashboard
4. 确认页面正常显示

### 步骤 2: 删除 Token
**方法 1: 使用开发者工具**
1. 按 `F12` 打开开发者工具
2. 切换到 **Application** 标签
3. 左侧菜单: Storage → Local Storage → `http://localhost:5173`
4. 找到 `token` 键
5. 右键点击 → Delete (或选中后按 Delete 键)

**方法 2: 使用 Console**
1. 按 `F12` 打开开发者工具
2. 切换到 **Console** 标签
3. 输入并执行:
   ```javascript
   localStorage.removeItem('token')
   ```

### 步骤 3: 触发 401 错误
刷新当前页面或访问受保护的页面:
```
http://localhost:5173/tools
http://localhost:5173/tools/link-dashboard
http://localhost:5173/posts/new
http://localhost:5173/profile
```

### 预期结果 ✅
1. **路由守卫拦截:** 因为没有 token,直接被路由守卫拦截
2. **自动跳转:** 页面重定向到 `http://localhost:5173/login?message=请先登录`
3. **显示提示:** 登录页红色错误框显示 "请先登录"
3. **清理状态:** 
   - localStorage 中的 `token` 被清除
   - localStorage 中的 `user` 被清除
   - Pinia store 状态重置

---

## 🔍 测试方法 B: 模拟后端返回 401

### 步骤 1: 临时修改后端
在 `backend/routers/categories.py` 或其他路由文件中,临时添加强制返回 401:

```python
@router.get("/categories")
async def get_categories(current_user: dict = Depends(get_current_user)):
    # 临时强制返回 401
    raise HTTPException(status_code=401, detail="Token 已过期")
    
    # 原来的代码...
```

### 步骤 2: 触发请求
1. 确保已登录
2. 访问链接管理工具
3. 页面会尝试加载分类列表,触发 API 请求

### 步骤 3: 观察结果
后端返回 401 后,前端应该:
- ✅ 拦截器捕获 401 错误
- ✅ 调用 `logout()` 清理 token
- ✅ 跳转到 `/login`
- ✅ 显示提示信息

### 步骤 4: 恢复后端代码
测试完成后,删除临时添加的代码

---

## 🎯 快速测试脚本

在浏览器 Console 中运行此脚本,一键测试:

```javascript
// 1. 确认当前有 token
console.log('当前 token:', localStorage.getItem('token'));

// 2. 删除 token
localStorage.removeItem('token');
console.log('Token 已删除');

// 3. 触发 API 请求(会返回 401)
fetch('/api/categories', {
  headers: {
    'Authorization': `Bearer invalid-token`
  }
})
.then(response => {
  if (response.status === 401) {
    console.log('✅ 成功触发 401 错误');
  }
})
.catch(error => {
  console.error('请求失败:', error);
});

// 4. 刷新页面观察跳转
setTimeout(() => {
  location.reload();
}, 1000);
```

---

## 📸 测试截图检查清单

### 截图 1: 删除 Token 前
- LocalStorage 显示 token 存在
- 当前在受保护页面

### 截图 2: 删除 Token 后
- LocalStorage 中 token 消失
- 准备刷新页面

### 截图 3: 401 提示
- Alert 弹框显示 "登录已过期,请重新登录"

### 截图 4: 跳转结果
- 地址栏显示 `/login`
- 登录页面正常显示

---

## ✅ 验证检查点

| 检查项 | 预期行为 | 实际结果 |
|--------|----------|----------|
| Token 被清除 | localStorage.getItem('token') 为 null | ⬜ |
| User 被清除 | localStorage.getItem('user') 为 null | ⬜ |
| 显示提示 | alert 显示 "登录已过期,请重新登录" | ⬜ |
| 自动跳转 | URL 变为 /login | ⬜ |
| 控制台日志 | Console 显示 "响应错误: ..." | ⬜ |

---

## 🐛 故障排查

### 问题 1: 没有自动跳转
**可能原因:**
- router 未正确导入
- 路由配置错误

**检查:**
```javascript
// 在 request.js 中确认
import router from '@/router';
```

### 问题 2: 没有提示信息
**可能原因:**
- alert 被浏览器拦截
- 代码未执行到 alert

**解决:**
- 检查浏览器是否允许弹窗
- 在 Console 查看是否有错误

### 问题 3: Token 未被清除
**可能原因:**
- `authStore.logout()` 未执行
- logout 方法实现有问题

**检查:**
```javascript
// stores/auth.js
logout() {
  this.token = null;
  this.user = null;
  localStorage.removeItem('token');
  localStorage.removeItem('user');
}
```

---

## 🔄 完整测试流程

1. **准备阶段**
   - ✅ 前后端服务器运行中
   - ✅ 已成功登录
   - ✅ 访问链接管理工具正常

2. **执行测试**
   - ⏳ 删除 localStorage 中的 token
   - ⏳ 刷新页面或访问受保护页面
   - ⏳ 观察是否弹出提示
   - ⏳ 观察是否跳转到 /login

3. **验证结果**
   - ⏳ 检查 localStorage 已清空
   - ⏳ 检查 URL 是否为 /login
   - ⏳ 检查提示信息是否显示

4. **后续测试**
   - ⏳ 重新登录
   - ⏳ 确认功能恢复正常

---

## 📝 测试记录模板

**测试执行人:** __________  
**测试时间:** 2025-10-19  
**测试方法:** □ 方法A(删除token) □ 方法B(后端401)

**测试结果:**
- [ ] ✅ 自动跳转到 /login
- [ ] ✅ 显示 "登录已过期,请重新登录"
- [ ] ✅ Token 被清除
- [ ] ✅ User 信息被清除
- [ ] ✅ 重新登录后功能正常

**问题记录:**
___________________________________________________

**截图附件:**
- [ ] 删除 token 前
- [ ] alert 提示
- [ ] 跳转后页面

---

**总结:** 该测试验证了 axios 拦截器正确处理 401 响应,实现了自动登出和友好提示。
