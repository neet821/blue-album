# 同步观影房间管理功能 - 快速测试指南

## 🚀 快速开始

### 1. 数据库迁移（已完成）
```powershell
✅ python scripts\database\add_member_online_status.py
```

### 2. 重启后端服务
```powershell
cd d:\Laragon\laragon\www\blue-local
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. 访问管理页面
- URL: `http://localhost:5173/admin/rooms`
- 需要管理员权限

---

## 🧪 测试场景

### 场景1: 管理员查看所有房间
1. 以管理员身份登录
2. 访问 `/admin/rooms`
3. 应该看到所有用户创建的房间
4. 显示房间代码、名称、房主、在线人数等

### 场景2: 查看房间详情
1. 点击任意房间的"查看"按钮
2. 应该显示房间详细信息
3. 应该显示所有成员列表（包括离线成员）
4. 在线成员标记为"在线"，离线成员标记为"离线"

### 场景3: 编辑房间信息
1. 点击任意房间的"编辑"按钮
2. 修改房间名称
3. 更改控制模式
4. 保存后应该立即更新

### 场景4: 成员离开后不显示
1. 创建一个房间并加入
2. 另一个用户也加入该房间
3. 第一个用户离开房间
4. 在成员列表中应该不再看到第一个用户
5. 但在管理员的"查看详情"中应该能看到（标记为离线）

### 场景5: 房主离开转移控制权
1. 创建一个"房主控制"模式的房间
2. 邀请其他成员加入
3. 房主离开房间
4. 所有在线成员应该收到提示："房主已离开，房间已转为全员控制模式"
5. 房间控制模式应自动变为"全员控制"
6. 其他成员现在应该可以控制播放

### 场景6: 空房间自动清理
**手动测试：**
1. 管理员进入"所有房间"页面
2. 点击"清理空房间"按钮
3. 应该看到清理结果消息

**自动测试（需要启动后台服务）：**
1. 启动清理服务：
   ```powershell
   python backend\background_tasks.py --interval 1 --timeout 2
   ```
2. 创建一个房间
3. 所有成员离开房间
4. 等待2分钟
5. 房间应该被自动删除

---

## 📋 API测试（Postman/cURL）

### 获取所有房间
```bash
curl -X GET http://localhost:8000/api/admin/sync-rooms \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 查看房间详情
```bash
curl -X GET http://localhost:8000/api/admin/sync-rooms/1 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 编辑房间
```bash
curl -X PUT http://localhost:8000/api/admin/sync-rooms/1 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "room_name": "新房间名称",
    "control_mode": "all_members"
  }'
```

### 删除房间
```bash
curl -X DELETE http://localhost:8000/api/admin/sync-rooms/1 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 清理空房间
```bash
curl -X POST http://localhost:8000/api/admin/sync-rooms/cleanup \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ✅ 验证清单

### 数据库
- [ ] `sync_room_members` 表有 `is_online` 字段
- [ ] `sync_room_members` 表有 `last_active_at` 字段
- [ ] 现有数据已正确迁移

### 后端API
- [ ] GET `/api/admin/sync-rooms` 返回所有房间
- [ ] GET `/api/admin/sync-rooms/{id}` 返回房间详情
- [ ] PUT `/api/admin/sync-rooms/{id}` 可以更新房间
- [ ] DELETE `/api/admin/sync-rooms/{id}` 可以删除房间
- [ ] POST `/api/admin/sync-rooms/cleanup` 可以清理空房间

### WebSocket事件
- [ ] 成员离开时触发 `member_left` 事件
- [ ] 房主离开时检测控制模式变化
- [ ] 控制模式变化时通知所有成员

### 前端功能
- [ ] 管理员可以访问 `/admin/rooms`
- [ ] 普通用户访问 `/admin/rooms` 被拒绝
- [ ] 房间列表正确显示
- [ ] 统计数据正确计算
- [ ] 查看功能正常
- [ ] 编辑功能正常
- [ ] 删除功能正常
- [ ] 清理功能正常
- [ ] 自动刷新正常（30秒）

### 业务逻辑
- [ ] 成员离开后标记为离线（不删除）
- [ ] 成员重新加入自动标记为在线
- [ ] 房主离开自动转为全员控制
- [ ] 空房间10分钟后自动删除
- [ ] 只在在线成员列表中显示在线成员

---

## 🐛 常见问题

### Q1: 管理员页面访问被拒绝
**A**: 确保当前用户的 `role` 字段为 `admin`

### Q2: 房间列表为空
**A**: 检查是否有活跃房间（`is_active = true`）

### Q3: 成员离开后仍然显示
**A**: 检查前端是否传递了 `online_only=true` 参数

### Q4: 后台清理服务不工作
**A**: 
- 检查服务是否正在运行
- 检查日志输出
- 确认间隔和超时参数设置

### Q5: 控制模式转移不生效
**A**: 
- 检查 WebSocket 连接是否正常
- 查看浏览器控制台是否收到 `member_left` 事件
- 检查后端日志

---

## 📊 测试数据准备

### 创建测试房间
```sql
-- 创建几个测试房间
INSERT INTO sync_rooms (room_code, room_name, host_user_id, control_mode, mode, video_source, is_active) 
VALUES 
  ('ROOM01', '测试房间1', 1, 'host_only', 'link', 'https://example.com/video1.mp4', 1),
  ('ROOM02', '测试房间2', 2, 'all_members', 'link', 'https://example.com/video2.mp4', 1),
  ('ROOM03', '空房间', 3, 'host_only', 'link', 'https://example.com/video3.mp4', 1);

-- 添加成员
INSERT INTO sync_room_members (room_id, user_id, nickname, is_online) 
VALUES 
  (1, 1, 'User1', 1),
  (1, 2, 'User2', 1),
  (2, 2, 'User2', 1),
  (2, 3, 'User3', 0);  -- 离线成员
```

---

## 📝 测试报告模板

```markdown
## 测试日期: YYYY-MM-DD
## 测试人员: 

### 功能测试结果

| 功能 | 状态 | 备注 |
|------|------|------|
| 管理员查看所有房间 | ✅/❌ | |
| 管理员查看房间详情 | ✅/❌ | |
| 管理员编辑房间 | ✅/❌ | |
| 管理员删除房间 | ✅/❌ | |
| 成员离线状态 | ✅/❌ | |
| 控制权转移 | ✅/❌ | |
| 空房间清理 | ✅/❌ | |

### 发现的问题

1. 问题描述
   - 重现步骤
   - 预期结果
   - 实际结果

### 建议

1. 优化建议
2. 改进方向
```

---

**准备完成，可以开始测试！** 🎉
