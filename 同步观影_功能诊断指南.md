# 🔍 同步观影功能诊断脚本

## 问题：进度条同步和聊天功能无效

---

## 🧪 诊断步骤

### 1️⃣ 检查数据库表是否创建

在 HeidiSQL 或 MySQL 客户端执行：

```sql
USE blue_local;

-- 检查表是否存在
SHOW TABLES LIKE 'sync_rooms%';

-- 应该看到3个表：
-- sync_rooms
-- sync_room_members  
-- sync_room_messages

-- 查看表结构
DESCRIBE sync_rooms;
DESCRIBE sync_room_members;
DESCRIBE sync_room_messages;
```

**如果表不存在**：
```sql
-- 执行迁移脚本
SOURCE D:\Laragon\laragon\www\blue-local\backend\migrations\sync_rooms_migration.sql;
```

---

### 2️⃣ 检查后端 WebSocket 服务

在浏览器打开：`http://localhost:8000/ws/socket.io/`

**预期结果**：
- ✅ 应该看到 Socket.IO 的响应（一串数字或 JSON）
- ❌ 如果看到 404，说明 WebSocket 未挂载

**检查后端日志**：
查看运行 uvicorn 的终端，应该看到：
```
INFO:engineio.server:Server initialized for asgi.
```

---

### 3️⃣ 检查前端 WebSocket 连接

**打开浏览器控制台（F12 → Console）**，进入播放器页面后应该看到：

```javascript
WebSocket 连接成功
加入房间成功 {room: {...}, members: [...]}
```

**如果没有看到这些日志**：

检查网络请求（F12 → Network → WS 标签）：
- 查找 `socket.io` 连接
- 状态应该是 `101 Switching Protocols`
- 如果是 `404`，说明 WebSocket 路径错误

---

### 4️⃣ 测试进度条同步

**步骤**：
1. 打开两个浏览器窗口（或使用隐私模式）
2. 第一个窗口：创建房间
3. 第二个窗口：使用房间代码加入
4. 在第一个窗口点击播放/暂停/拖动进度条
5. 观察第二个窗口是否同步

**检查控制台**：
```javascript
// 房主操作时应该看到
playback_control 发送: {action: 'play', room_id: 1, user_id: 1}

// 成员端应该看到
playback_sync 接收: {action: 'play', ...}
```

---

### 5️⃣ 测试聊天功能

**步骤**：
1. 在聊天输入框输入消息
2. 点击发送
3. 检查是否出现在聊天列表

**检查控制台**：
```javascript
// 发送消息时应该看到
send_message 发送: {message: '你好', room_id: 1, user_id: 1, username: 'admin'}

// 接收消息时应该看到
new_message 接收: {message: '你好', username: 'admin', created_at: '2025-10-19...'}
```

---

## 🐛 常见问题和解决方案

### 问题1：WebSocket 404 错误

**症状**：
```
GET http://localhost:8000/ws/socket.io/?EIO=4&transport=polling 404
```

**原因**：WebSocket 未正确挂载

**解决方法**：
检查 `backend/main.py` 文件末尾是否有：
```python
# 必须在所有路由之后
app.mount("/ws", socket_app)
```

**验证**：
```bash
# 在终端测试
curl http://localhost:8000/ws/socket.io/
# 应该返回一些数据，不是 404
```

---

### 问题2：跨域 CORS 错误

**症状**：
```
Access to XMLHttpRequest at 'http://localhost:8000' from origin 'http://localhost:5173' 
has been blocked by CORS policy
```

**解决方法**：
检查 `backend/main.py` 的 CORS 配置：
```python
origins = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
    "http://localhost:5174",
    "http://127.0.0.1:5174",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

### 问题3：用户 ID 或用户名为 undefined

**症状**：
```javascript
user_id: undefined
username: undefined
```

**原因**：用户未登录或 authStore 未正确获取

**解决方法**：

检查 `SyncRoomPlayer.vue` 的代码：
```javascript
import { useAuthStore } from '../stores/auth';

const authStore = useAuthStore();
const currentUserId = computed(() => authStore.user?.id);
const currentUsername = computed(() => authStore.user?.username);
```

**验证**：
在浏览器控制台：
```javascript
// 检查 localStorage
console.log(localStorage.getItem('auth-token'));

// 检查 authStore
console.log(authStore.user);  // 应该有 id 和 username
```

---

### 问题4：进度条不同步

**可能原因**：

1. **权限问题**：非房主在 `host_only` 模式下无法控制
   ```javascript
   const canControl = computed(() => {
     return roomInfo.value.control_mode === 'all_members' || isHost.value;
   });
   ```

2. **`isUpdating` 标志未正确重置**
   ```javascript
   // 检查是否陷入 isUpdating = true 状态
   console.log('isUpdating:', isUpdating);
   ```

3. **WebSocket 未连接**
   ```javascript
   console.log('Socket 状态:', socket.value?.connected);
   ```

**解决方法**：
在控制台手动测试：
```javascript
// 手动发送播放命令
socket.value.emit('playback_control', {
  room_id: 1,
  user_id: 1,
  action: 'play'
});

// 监听响应
socket.value.on('playback_sync', (data) => {
  console.log('收到同步:', data);
});
```

---

### 问题5：聊天消息不显示

**可能原因**：

1. **WebSocket 事件未监听**
   ```javascript
   // 检查是否注册了 new_message 监听
   socket.value.on('new_message', (data) => {
     messages.value.push(data);
     scrollToBottom();
   });
   ```

2. **消息未保存到数据库**
   - 检查后端日志是否有错误
   - 检查 `sync_room_messages` 表是否有数据

3. **滚动到底部失败**
   ```javascript
   const scrollToBottom = () => {
     nextTick(() => {
       if (chatMessages.value) {
         chatMessages.value.scrollTop = chatMessages.value.scrollHeight;
       }
     });
   };
   ```

**解决方法**：
```javascript
// 手动发送消息测试
socket.value.emit('send_message', {
  room_id: 1,
  user_id: 1,
  username: 'test',
  message: '测试消息'
});

// 检查数据库
// 在 HeidiSQL 执行：
SELECT * FROM sync_room_messages ORDER BY created_at DESC LIMIT 10;
```

---

## 🔧 快速修复命令

### 1. 重启后端服务
```bash
# 停止当前服务（Ctrl+C）
cd d:\Laragon\laragon\www\blue-local
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. 清除浏览器缓存
```
按 Ctrl + Shift + Delete
选择"缓存的图像和文件"
清除
```

### 3. 强制刷新前端
```
按 Ctrl + Shift + R
```

### 4. 检查依赖
```bash
# 后端
pip list | findstr socketio
# 应该看到: python-socketio 5.10.0

# 前端
cd frontend
npm list socket.io-client
# 应该看到: socket.io-client@x.x.x
```

---

## 📊 完整的测试流程

### 测试脚本（在浏览器控制台执行）

```javascript
// ========== 测试 WebSocket 连接 ==========
console.log('=== WebSocket 诊断开始 ===');

// 1. 检查 socket 对象
console.log('Socket 对象存在:', !!socket.value);
console.log('Socket 已连接:', socket.value?.connected);
console.log('Socket ID:', socket.value?.id);

// 2. 检查用户信息
console.log('当前用户 ID:', currentUserId.value);
console.log('当前用户名:', currentUsername.value);
console.log('房间 ID:', roomId.value);

// 3. 检查房间信息
console.log('房间信息:', roomInfo.value);
console.log('是否房主:', isHost.value);
console.log('可否控制:', canControl.value);

// 4. 测试发送播放命令
console.log('=== 测试播放控制 ===');
socket.value.emit('playback_control', {
  room_id: parseInt(roomId.value),
  user_id: currentUserId.value,
  action: 'play'
});

// 5. 测试发送消息
console.log('=== 测试聊天消息 ===');
socket.value.emit('send_message', {
  room_id: parseInt(roomId.value),
  user_id: currentUserId.value,
  username: currentUsername.value,
  message: '诊断测试消息'
});

console.log('=== WebSocket 诊断完成 ===');
```

---

## 🎯 预期的正常行为

### 进度条同步
1. **房主操作** → 发送 WebSocket 事件 → **所有成员同步**
2. **延迟** < 1 秒
3. **误差阈值** < 2 秒（自动校正）

### 聊天功能
1. **输入消息** → 点击发送 → **立即显示**
2. **其他成员** → 同时收到消息
3. **消息保存** → 数据库持久化

---

## 📝 检查清单

运行同步观影功能前，确保：

- [ ] ✅ 数据库表已创建（`sync_rooms`, `sync_room_members`, `sync_room_messages`）
- [ ] ✅ 后端服务运行中（端口 8000）
- [ ] ✅ 后端日志显示 "Server initialized for asgi."
- [ ] ✅ 前端服务运行中（端口 5173）
- [ ] ✅ 用户已登录（有 token）
- [ ] ✅ 浏览器控制台无错误
- [ ] ✅ WebSocket 连接成功（状态 101）
- [ ] ✅ 可以创建房间
- [ ] ✅ 可以加入房间
- [ ] ✅ 可以看到成员列表
- [ ] ✅ 视频可以播放
- [ ] ✅ 控制台有 WebSocket 日志

---

## 🚑 紧急修复步骤

如果功能完全无效：

1. **停止所有服务**
2. **执行数据库迁移**
   ```sql
   SOURCE D:\Laragon\laragon\www\blue-local\backend\migrations\sync_rooms_migration.sql;
   ```
3. **重启后端**
   ```bash
   cd d:\Laragon\laragon\www\blue-local
   uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
   ```
4. **清除浏览器缓存**
5. **重启前端**（如果需要）
6. **重新登录**
7. **创建新房间测试**

---

**下一步**：请告诉我在哪一步遇到了问题，我会提供针对性的解决方案。
