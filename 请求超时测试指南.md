# ⏱️ 请求超时测试指南

**测试目标:** 验证 axios 拦截器的 10 秒超时配置是否正常工作  
**测试时间:** 2025年10月19日

---

## 📋 测试方法

### 方式 A: 修改后端添加延迟接口 (推荐用于生产验证)

#### 1. 创建测试接口

在 `backend/main.py` 中添加:

```python
import asyncio

@app.get("/api/test/timeout")
async def test_timeout():
    """测试超时接口 - 延迟 12 秒响应"""
    await asyncio.sleep(12)  # 超过前端 10 秒超时设置
    return {"message": "如果你看到这条消息,说明没有触发超时"}
```

#### 2. 测试步骤

1. 启动后端服务
2. 在前端任意页面的 Console 执行:
   ```javascript
   import('/src/utils/request.js').then(module => {
     module.default.get('/test/timeout')
       .then(res => console.log('✅ 响应:', res.data))
       .catch(err => console.error('❌ 错误:', err.message))
   })
   ```

#### 3. 预期结果

- ⏱️ **10 秒后** 请求中断
- ❌ Console 显示错误:
  ```
  ⏱️ 请求超时: Error: timeout of 10000ms exceeded
  ❌ 错误: 请求超时,请检查网络连接后重试
  ```
- 🌐 Network 标签显示:
  - Status: `(failed)` 或 `ERR_TIMEOUT`
  - Type: `xhr` 或 `fetch`
  - Time: `~10.00s`

---

### 方式 B: 临时修改前端超时时间 (快速测试)

**⚠️ 注意:** 测试完成后需要恢复原设置

#### 1. 临时修改超时时间

打开浏览器 Console,执行:

```javascript
// 保存原始超时时间
const originalTimeout = window.__requestTimeout || 10000;

// 修改为 1 秒 (用于快速触发超时)
import('/src/utils/request.js').then(module => {
  const request = module.default;
  request.defaults.timeout = 1000; // 改为 1 秒
  console.log('✅ 超时时间已临时设置为 1 秒');
});
```

#### 2. 触发任意 API 请求

方法 1 - 访问链接管理 (需要登录):
```javascript
window.location.href = 'http://localhost:5173/tools/link-dashboard'
```

方法 2 - 手动发送测试请求:
```javascript
import('/src/utils/request.js').then(module => {
  module.default.get('/categories')
    .then(res => console.log('✅ 响应:', res.data))
    .catch(err => console.error('❌ 错误:', err.message))
});
```

#### 3. 预期结果

- ⏱️ **1 秒后** 请求超时
- ❌ Console 显示:
  ```
  ⏱️ 请求超时: Error: timeout of 1000ms exceeded
  ❌ 错误: 请求超时,请检查网络连接后重试
  ```
- 🌐 Network 标签显示超时错误

#### 4. 恢复原设置

**重要:** 测试完成后刷新页面,或手动恢复:

```javascript
import('/src/utils/request.js').then(module => {
  module.default.defaults.timeout = 10000; // 恢复 10 秒
  console.log('✅ 超时时间已恢复为 10 秒');
});
```

或者直接刷新页面: `Ctrl + Shift + R`

---

## 🎯 更简单的测试方式 (推荐)

### 创建测试页面组件

在开发环境中使用浏览器的网络限速功能:

#### 1. 打开网络限速

1. 按 `F12` 打开开发者工具
2. 切换到 **Network** 标签
3. 找到 **Throttling** 下拉菜单 (通常在顶部)
4. 选择 **Slow 3G** 或 **Add custom profile**

#### 2. 自定义超慢网络

创建自定义配置:
- Download: `1 KB/s`
- Upload: `1 KB/s`
- Latency: `5000 ms`

#### 3. 触发请求

访问任何需要加载数据的页面,例如:
- http://localhost:5173/tools/link-dashboard
- http://localhost:5173/posts

#### 4. 观察结果

由于网络极慢,请求会在 10 秒后超时。

---

## 📊 测试验证清单

### ✅ 成功标准

- [ ] **Console 输出**
  - [ ] 显示 `⏱️ 请求超时:` 日志
  - [ ] 错误消息为: `"请求超时,请检查网络连接后重试"`
  
- [ ] **Network 面板**
  - [ ] 请求状态显示为 `(failed)` 或红色
  - [ ] Time 列显示约 10 秒 (或设置的超时时间)
  - [ ] Type 为 `xhr` 或 `fetch`

- [ ] **用户界面**
  - [ ] 页面显示错误提示 (如果有错误处理 UI)
  - [ ] 不会出现无限加载状态

- [ ] **代码行为**
  - [ ] catch 块被正确触发
  - [ ] error.message 包含超时相关信息
  - [ ] 不影响其他功能

### ❌ 失败情况

如果看到以下情况,说明超时处理有问题:

- 请求永久 pending,从不结束
- 超过 10 秒后仍在等待响应
- Console 没有超时错误日志
- 错误消息不友好 (显示原始错误代码)

---

## 🧪 完整测试脚本

### 测试脚本 1: 基础超时测试

```javascript
console.log('🧪 开始超时测试...');

// 临时修改超时为 2 秒
import('/src/utils/request.js').then(async module => {
  const request = module.default;
  const originalTimeout = request.defaults.timeout;
  
  console.log(`⏰ 原始超时: ${originalTimeout}ms`);
  
  // 设置为 2 秒
  request.defaults.timeout = 2000;
  console.log(`⏰ 临时超时: ${request.defaults.timeout}ms`);
  
  // 尝试请求一个会延迟的接口
  console.log('📡 发送测试请求...');
  
  try {
    // 这里使用任意 API 接口,配合网络限速可能触发超时
    const response = await request.get('/categories');
    console.log('✅ 请求成功:', response.data);
  } catch (error) {
    console.log('❌ 捕获错误:');
    console.log('  - 错误代码:', error.code);
    console.log('  - 错误消息:', error.message);
    console.log('  - 是否超时:', error.code === 'ECONNABORTED');
  }
  
  // 恢复原设置
  request.defaults.timeout = originalTimeout;
  console.log(`✅ 已恢复超时为: ${originalTimeout}ms`);
});
```

### 测试脚本 2: 模拟慢速 API

```javascript
console.log('🧪 开始慢速 API 测试...');

// 设置超时为 3 秒
import('/src/utils/request.js').then(async module => {
  const request = module.default;
  request.defaults.timeout = 3000;
  
  console.log('⏱️ 超时设置为 3 秒');
  console.log('📡 请在 Network 标签中将网络限速设为 "Slow 3G"');
  console.log('📡 发送请求中...');
  
  const startTime = Date.now();
  
  try {
    await request.get('/categories');
    const duration = Date.now() - startTime;
    console.log(`✅ 请求成功,耗时: ${duration}ms`);
  } catch (error) {
    const duration = Date.now() - startTime;
    console.log(`❌ 请求失败,耗时: ${duration}ms`);
    console.log(`❌ 错误: ${error.message}`);
  }
  
  // 恢复 10 秒
  request.defaults.timeout = 10000;
  console.log('✅ 超时已恢复为 10 秒');
});
```

---

## 📸 截图要求

请在测试时截取以下内容:

### 1. Console 输出
显示:
- `⏱️ 请求超时:` 日志
- 错误对象详情
- 自定义错误消息

### 2. Network 面板
显示:
- 请求 URL
- Status: `(failed)` 或 `ERR_TIMEOUT`
- Time: 接近 10 秒 (或设置的超时值)
- Type: `xhr` 或 `fetch`

### 3. 页面错误提示 (如果有)
显示错误消息的 UI 组件

---

## 🐛 故障排查

### 问题 1: 无法触发超时

**可能原因:**
- 网络太快,接口响应时间 < 10 秒
- 超时时间设置未生效

**解决方法:**
1. 使用 Chrome DevTools 的网络限速
2. 临时将超时改为 1 秒: `request.defaults.timeout = 1000`
3. 或使用方式 A 创建延迟接口

### 问题 2: 超时后没有友好提示

**可能原因:**
- 组件的 catch 块没有显示 error.message
- 错误被吞掉了

**解决方法:**
检查调用 request 的组件,确保:
```javascript
try {
  await request.get('/some-api');
} catch (error) {
  // 应该显示 error.message 给用户
  errorMessage.value = error.message; // ✅ 正确
  console.error(error); // ✅ 至少记录日志
}
```

### 问题 3: 刷新后设置消失

**这是正常的!** 
- 超时设置存在内存中,刷新页面会重置
- 如需永久修改,直接编辑 `request.js` 中的 `timeout: 10000`

---

## ✅ 测试完成检查表

- [ ] 方式 A 或方式 B 至少完成一种
- [ ] Console 显示友好的超时错误消息
- [ ] Network 面板显示超时状态
- [ ] 截图保存 Console 和 Network 证据
- [ ] 测试后恢复原设置 (如使用方式 B)
- [ ] 验证其他 API 请求不受影响

---

**测试愉快! ⏱️**
