# 🐳 Blue Local 多种部署方案完整指南

## 📋 部署方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **传统部署** | 性能最优，灵活度高 | 配置复杂，依赖管理困难 | 生产环境，大流量 |
| **Docker部署** | 环境隔离，部署简单，可移植性强 | 轻微性能损耗 | 开发/测试/生产 |
| **云平台PaaS** | 自动扩展，运维简单 | 成本较高，平台绑定 | 快速上线，团队项目 |
| **Kubernetes** | 高可用，自动扩展，适合微服务 | 学习成本高，复杂 | 大型项目，企业级 |

---

## 🚀 方案一：Docker 部署（推荐新手）

### 优势
- ✅ 一键部署，3分钟完成
- ✅ 环境完全隔离，避免依赖冲突
- ✅ 本地和服务器使用相同配置
- ✅ 易于迁移和备份

### 前置要求
- Docker 20.10+
- Docker Compose 1.29+

### 快速开始

#### 1. Windows本地构建前端
```bash
cd d:\Laragon\laragon\www\blue-local\frontend
npm install
npm run build
```

#### 2. 上传到服务器
```bash
# 压缩项目（排除node_modules）
# 上传整个项目到服务器 /var/www/blue-local
```

#### 3. 服务器部署
```bash
cd /var/www/blue-local
chmod +x scripts/deployment/deploy-docker.sh
./scripts/deployment/deploy-docker.sh
```

#### 4. 验证部署
```bash
# 检查容器状态
docker-compose ps

# 访问网站
curl http://localhost
```

### Docker常用命令
```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看日志
docker-compose logs -f backend
docker-compose logs -f mysql

# 重启特定服务
docker-compose restart backend

# 进入容器
docker exec -it blue-local-backend bash

# 查看资源使用
docker stats
```

### 故障排查
```bash
# 检查容器状态
docker-compose ps

# 查看完整日志
docker-compose logs --tail=100

# 重新构建
docker-compose up -d --build --force-recreate

# 清理并重新部署
docker-compose down -v
docker-compose up -d --build
```

---

## 🖥️ 方案二：传统Linux服务器部署

### 优势
- ✅ 性能最优，直接运行在系统上
- ✅ 完全控制，灵活度高
- ✅ 适合生产环境

### 系统要求
- Ubuntu 20.04+ / CentOS 7+
- Python 3.9+
- MySQL 8.0+
- Nginx

### 快速部署
```bash
# 1. 运行打包脚本（Windows）
cd d:\Laragon\laragon\www\blue-local\scripts\deployment
package.bat

# 2. 上传到服务器
scp -r deploy-package user@server:/var/www/blue-local

# 3. 执行部署
ssh user@server
cd /var/www/blue-local
sudo chmod +x scripts/deploy.sh
sudo ./scripts/deploy.sh
```

详见：`docs/deployment/服务器部署指南.md`

---

## ☁️ 方案三：阿里云/腾讯云 PaaS 部署

### 3.1 阿里云 ECS + RDS

#### 架构
```
用户 → 阿里云SLB负载均衡 → ECS实例（Nginx+Backend） → RDS数据库
```

#### 部署步骤

**1. 创建RDS MySQL实例**
- 版本：MySQL 8.0
- 规格：1核2GB（入门）
- 存储：20GB SSD
- 创建数据库：`blue_local_db`

**2. 创建ECS实例**
- 系统：Ubuntu 20.04
- 规格：2核4GB（推荐）
- 带宽：5Mbps（按需调整）
- 安全组：开放80, 443端口

**3. 配置环境**
```bash
# SSH连接到ECS
ssh root@your-ecs-ip

# 安装Docker
curl -fsSL https://get.docker.com | sh

# 部署项目
git clone your-repo
cd blue-local
# 修改.env中的数据库地址为RDS内网地址
./scripts/deployment/deploy-docker.sh
```

**4. 配置域名和SSL**
```bash
# 安装Certbot
apt-get install certbot

# 申请证书
certbot certonly --standalone -d yourdomain.com
```

#### 成本估算（按月）
- ECS（2核4GB）：¥100-150
- RDS（1核2GB）：¥100-200
- 带宽（5Mbps）：¥30-50
- **总计：¥230-400/月**

### 3.2 腾讯云轻量应用服务器

#### 部署步骤
```bash
# 1. 购买轻量应用服务器
# 选择：2核4GB，6Mbps，80GB SSD，¥99/月

# 2. 选择镜像：Docker CE

# 3. 上传代码并部署
scp -r deploy-package lighthouse@your-ip:/home/lighthouse/
ssh lighthouse@your-ip
cd /home/lighthouse/deploy-package
./scripts/deployment/deploy-docker.sh
```

---

## 🌐 方案四：Vercel + PlanetScale（适合演示/个人项目）

### 架构
- 前端：Vercel（免费托管）
- 后端：Railway/Render（免费额度）
- 数据库：PlanetScale（免费5GB）

### 优势
- ✅ 完全免费（小流量）
- ✅ 自动HTTPS
- ✅ 全球CDN加速
- ✅ 自动部署

### 部署步骤

#### 1. 前端部署到Vercel

**创建 `vercel.json`：**
```json
{
  "buildCommand": "cd frontend && npm run build",
  "outputDirectory": "frontend/dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://your-backend.railway.app/api/:path*"
    },
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
```

**部署：**
```bash
# 安装Vercel CLI
npm install -g vercel

# 登录
vercel login

# 部署
cd d:\Laragon\laragon\www\blue-local
vercel --prod
```

#### 2. 后端部署到Railway

**创建 `railway.toml`：**
```toml
[build]
builder = "nixpacks"

[deploy]
startCommand = "python -m uvicorn backend.main:app --host 0.0.0.0 --port $PORT"
restartPolicyType = "on-failure"
```

**部署：**
```bash
# 安装Railway CLI
npm install -g @railway/cli

# 登录
railway login

# 初始化
railway init

# 部署
railway up
```

#### 3. 数据库配置PlanetScale

```bash
# 注册：https://planetscale.com/
# 创建数据库：blue-local-db
# 获取连接字符串
# 在Railway设置环境变量：DATABASE_URL
```

---

## ☸️ 方案五：Kubernetes 部署（企业级）

### 适用场景
- 大流量（1000+ 并发用户）
- 需要高可用
- 多团队协作
- 自动扩缩容

### 快速开始

**创建 Kubernetes 配置文件：**

`k8s/deployment.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blue-local-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: blue-local-backend
  template:
    metadata:
      labels:
        app: blue-local-backend
    spec:
      containers:
      - name: backend
        image: your-registry/blue-local:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: blue-local-secrets
              key: database-url
---
apiVersion: v1
kind: Service
metadata:
  name: blue-local-backend
spec:
  selector:
    app: blue-local-backend
  ports:
  - port: 8000
    targetPort: 8000
  type: LoadBalancer
```

**部署：**
```bash
kubectl apply -f k8s/
kubectl get pods
kubectl get services
```

---

## 📊 性能优化建议

### 1. 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_article_author ON articles(author_id);
CREATE INDEX idx_room_host ON sync_rooms(host_user_id);
CREATE INDEX idx_member_online ON sync_room_members(is_online);

-- 优化查询
-- 使用EXPLAIN分析慢查询
```

### 2. 缓存配置
```python
# 安装Redis
pip install redis

# 添加缓存层
from redis import Redis
cache = Redis(host='localhost', port=6379)
```

### 3. CDN加速
- 静态资源托管到OSS
- 使用阿里云CDN/腾讯云CDN
- Cloudflare免费CDN

### 4. 负载均衡
```nginx
upstream backend {
    server backend1:8000;
    server backend2:8000;
    server backend3:8000;
}

server {
    location /api {
        proxy_pass http://backend;
    }
}
```

---

## 🔒 安全加固

### 1. 使用HTTPS
```bash
# Let's Encrypt免费证书
certbot --nginx -d yourdomain.com
```

### 2. 防火墙配置
```bash
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

### 3. 限流配置
```nginx
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

location /api {
    limit_req zone=api burst=20;
}
```

---

## 📈 监控和日志

### 1. 日志收集
```bash
# 使用ELK Stack
docker-compose -f elk-stack.yml up -d
```

### 2. 性能监控
```bash
# Prometheus + Grafana
docker-compose -f monitoring.yml up -d
```

### 3. 告警配置
- 服务宕机告警
- 磁盘空间告警
- 数据库连接数告警

---

## 🎯 选择建议

| 场景 | 推荐方案 | 理由 |
|------|---------|------|
| **个人学习** | Docker本地 | 简单快速 |
| **团队Demo** | Vercel+Railway | 免费，快速 |
| **小型项目** | 云服务器+Docker | 性价比高 |
| **中型项目** | 阿里云ECS+RDS | 稳定可靠 |
| **大型项目** | Kubernetes | 高可用，可扩展 |

---

## 📞 获取帮助

需要部署协助？请提供：
1. 选择的部署方案
2. 服务器配置
3. 遇到的问题

祝部署顺利！🎉
