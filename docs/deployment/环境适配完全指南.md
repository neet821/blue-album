# 环境适配完全指南

## 🎯 核心问题：本地 vs 服务器环境差异

### 差异对比表

| 项目 | 本地 Windows | 服务器 Linux | 解决方案 |
|------|-------------|-------------|---------|
| **路径分隔符** | `\` (反斜杠) | `/` (正斜杠) | ✅ 使用 `Path()` 自动处理 |
| **项目根目录** | `d:\Laragon\...` | `/var/www/...` | ✅ 自动检测 `__file__` |
| **Python 路径** | `C:\Python\...` | `/usr/bin/python3` | ✅ 虚拟环境统一 |
| **数据库主机** | `localhost` | `127.0.0.1` 或容器名 | ✅ 环境变量配置 |
| **服务器地址** | `127.0.0.1` | `0.0.0.0` | ✅ 根据环境自动选择 |
| **端口占用** | 可能冲突 | 可能冲突 | ✅ 检测并提示 |
| **文件权限** | 自动 | 需要设置 | ✅ 部署脚本自动处理 |

---

## ✅ 已实现的自适应机制

### 1. **环境自动检测** (`backend/config.py`)

```python
# 自动识别运行环境
- Windows + Laragon → development
- Linux 生产服务器 → production  
- Docker 容器 → docker

# 根据环境自动调整：
- 数据库连接
- 服务器监听地址
- CORS 白名单
- 日志级别
```

### 2. **跨平台路径处理**

```python
# ❌ 错误写法（Windows 专用）
path = "d:\\uploads\\file.jpg"

# ✅ 正确写法（跨平台）
from pathlib import Path
path = Path(__file__).parent / "uploads" / "file.jpg"
# Windows: d:\project\uploads\file.jpg
# Linux: /var/www/project/uploads/file.jpg
```

### 3. **环境变量配置**

```bash
# 本地 .env
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=
CORS_ORIGINS=http://localhost:5173

# 服务器 .env
DB_HOST=127.0.0.1
DB_USER=blue_user
DB_PASSWORD=StrongPassword123!
CORS_ORIGINS=https://yourdomain.com
```

---

## 🚀 部署前检查清单

### 步骤1：验证本地环境

```powershell
# 在本地运行环境检测
cd d:\Laragon\laragon\www\blue-local
python scripts\deployment\validate-environment.py
```

**预期输出：**
```
✓ Python 3.11+
✓ Node.js 18+
✓ MySQL running
✓ All dependencies installed
✓ Project structure correct
✓ .env file configured
```

### 步骤2：测试配置自适应

```powershell
# 测试配置检测
python backend\config.py
```

**预期输出：**
```
============================================================
🖥️  Environment: development
🔧 Platform: Windows 10
📁 Project Root: d:\Laragon\laragon\www\blue-local
🗄️  Database: localhost:3306/blue_album
🌐 Server: 127.0.0.1:8000
🔐 CORS Origins: ['http://localhost:5173', ...]
📝 Log Level: DEBUG
============================================================
```

### 步骤3：打包部署文件

```powershell
# 收集所有部署文件
.\scripts\deployment\collect-deployment-files.ps1

# 压缩打包
Compress-Archive -Path deployment-package -DestinationPath blue-local-deploy.zip
```

### 步骤4：上传到服务器

```powershell
# 上传部署包
scp blue-local-deploy.zip user@server:/tmp/

# 或使用 Git 同步
.\scripts\sync\push-shared-branch.ps1
```

### 步骤5：服务器端验证

```bash
# SSH 到服务器
ssh user@server

# 解压（如果用 SCP）
cd /var/www
unzip /tmp/blue-local-deploy.zip
mv deployment-package blue-local
cd blue-local

# 或拉取 Git（如果用同步分支）
git clone https://github.com/neet821/blue-album.git blue-local
cd blue-local
git checkout shared/win-sync
git pull

# 运行环境检测
python3 scripts/deployment/validate-environment.py
```

**预期服务器输出：**
```
============================================================
🖥️  Environment: production
🔧 Platform: Linux 5.x
📁 Project Root: /var/www/blue-local
🗄️  Database: 127.0.0.1:3306/blue_album
🌐 Server: 0.0.0.0:8000
🔐 CORS Origins: ['https://yourdomain.com', ...]
📝 Log Level: INFO
============================================================
```

---

## 🛠️ 需要手动配置的项目

### 1. **服务器 .env 文件**

```bash
# 复制模板
cp .env.example .env

# 编辑配置（重要！）
nano .env
```

**必须修改的变量：**
```bash
# 数据库密码（不要用空密码！）
DB_PASSWORD=你的强密码

# JWT 密钥（至少32字符）
SECRET_KEY=生成一个随机字符串_至少32字符

# 允许的前端域名
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# 如果使用 Docker
DOCKER_ENV=true
DB_HOST=mysql  # Docker 服务名
```

### 2. **数据库创建**

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE blue_album CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'blue_user'@'localhost' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON blue_album.* TO 'blue_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3. **文件权限设置**

```bash
# 设置项目目录权限
sudo chown -R www-data:www-data /var/www/blue-local
sudo chmod -R 755 /var/www/blue-local

# 可写目录权限
sudo chmod -R 775 /var/www/blue-local/uploads
sudo chmod -R 775 /var/www/blue-local/logs
```

---

## 📋 常见问题与解决方案

### 问题1: 路径错误

```python
# ❌ 错误
FileNotFoundError: d:\uploads\file.jpg

# ✅ 解决
# 代码已使用 Path() 自动处理
from backend.config import config
upload_dir = config.UPLOAD_DIR  # 自动适配平台
```

### 问题2: 数据库连接失败

```bash
# 检查数据库是否运行
sudo systemctl status mysql

# 检查端口是否开放
netstat -tulpn | grep 3306

# 检查 .env 配置
cat .env | grep DB_

# 测试连接
mysql -h 127.0.0.1 -u blue_user -p blue_album
```

### 问题3: CORS 错误

```bash
# 检查 .env 的 CORS_ORIGINS
cat .env | grep CORS_ORIGINS

# 确保包含前端域名
CORS_ORIGINS=https://yourdomain.com,http://localhost:5173

# 重启后端服务
docker-compose restart backend
# 或
sudo systemctl restart blue-local
```

### 问题4: 端口被占用

```bash
# 检查端口占用
sudo lsof -i :8000
sudo lsof -i :3306

# 杀死占用进程
sudo kill -9 <PID>

# 或修改 .env 使用其他端口
PORT=8001
```

### 问题5: 权限不足

```bash
# 上传文件失败
sudo chown -R www-data:www-data /var/www/blue-local/uploads
sudo chmod -R 775 /var/www/blue-local/uploads

# 日志写入失败
sudo chown -R www-data:www-data /var/www/blue-local/logs
sudo chmod -R 775 /var/www/blue-local/logs
```

---

## ✅ 部署成功标志

### 本地测试通过

```powershell
# 1. 环境验证通过
python scripts\deployment\validate-environment.py
# ✓ All checks passed

# 2. 配置检测正确
python backend\config.py
# ✓ Environment: development
# ✓ Database: localhost:3306

# 3. 启动成功
python -m uvicorn backend.main:app --reload
# ✓ Application startup complete
```

### 服务器测试通过

```bash
# 1. 环境验证通过
python3 scripts/deployment/validate-environment.py
# ✓ All checks passed

# 2. 配置检测正确
python3 backend/config.py
# ✓ Environment: production
# ✓ Database: 127.0.0.1:3306

# 3. Docker 启动成功
docker-compose up -d
docker-compose logs
# ✓ All services running

# 4. API 响应正常
curl http://localhost:8000/api/health
# {"status": "ok", "environment": "production"}
```

---

## 🎯 一键部署命令

### Docker 部署（推荐）

```bash
# 服务器端一键部署
cd /var/www/blue-local
chmod +x scripts/deployment/deploy-docker.sh
./scripts/deployment/deploy-docker.sh
```

### 传统部署

```bash
# 服务器端传统部署
cd /var/www/blue-local
chmod +x scripts/deployment/deploy.sh
./scripts/deployment/deploy.sh
```

---

## 📚 相关文件

- `backend/config.py` - 环境自适应配置
- `backend/database.py` - 数据库连接（使用 config）
- `scripts/deployment/validate-environment.py` - 环境检测脚本
- `scripts/deployment/collect-deployment-files.ps1` - 文件收集脚本
- `.env.example` - 环境变量模板
- `deployment-package/DEPLOYMENT_README.md` - 部署说明

---

## 🔄 更新部署

### 本地更新推送

```powershell
# 本地开发完成后
git add .
git commit -m "feat: new feature"
git push origin main

# 推送到同步分支
.\scripts\sync\push-shared-branch.ps1
```

### 服务器端更新

```bash
# 拉取最新代码
cd /var/www/blue-local
git pull origin main

# Docker 方式更新
docker-compose down
docker-compose up -d --build

# 传统方式更新
sudo systemctl restart blue-local
sudo systemctl restart nginx
```

---

**核心思想：写一次代码，自动适配所有环境！** 🚀
