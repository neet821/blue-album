# ✅ 同步观影功能 - 数据库表创建指南

## 数据库信息
- **数据库名**: `blue_local_db`
- **需要创建的表**: 3个

---

## 🚀 快速创建（推荐）

### 方法1：在 HeidiSQL 中执行

1. **打开 HeidiSQL**
2. **连接到 MySQL** 
3. **点击 "查询" 标签（或按 F9）**
4. **粘贴以下 SQL**：

```sql
USE blue_local_db;

-- 检查表是否存在
SHOW TABLES LIKE 'sync_rooms%';

-- 如果没有表，执行下面的创建语句
```

5. **执行完整的迁移脚本**：

   在 HeidiSQL 的查询窗口选择：**文件 → 执行 SQL 文件**
   
   选择：`D:\Laragon\laragon\www\blue-local\backend\migrations\快速创建同步观影表.sql`

6. **验证结果**：

```sql
USE blue_local_db;

SELECT 
    TABLE_NAME,
    TABLE_ROWS,
    CREATE_TIME
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'blue_local_db' 
  AND TABLE_NAME IN ('sync_rooms', 'sync_room_members', 'sync_room_messages');
```

应该看到3个表：
```
sync_rooms
sync_room_members
sync_room_messages
```

---

### 方法2：使用命令行

```bash
# 在 Windows PowerShell 或 CMD 中执行
mysql -u root -p blue_local_db < "D:\Laragon\laragon\www\blue-local\backend\migrations\快速创建同步观影表.sql"
```

---

## 🔍 检查表是否创建成功

### 检查脚本（在 HeidiSQL 执行）

```sql
-- 1. 切换数据库
USE blue_local_db;

-- 2. 列出所有同步观影相关的表
SHOW TABLES LIKE 'sync_rooms%';

-- 3. 查看表结构
DESCRIBE sync_rooms;
DESCRIBE sync_room_members;
DESCRIBE sync_room_messages;

-- 4. 查看表的详细信息
SHOW CREATE TABLE sync_rooms\G
SHOW CREATE TABLE sync_room_members\G
SHOW CREATE TABLE sync_room_messages\G
```

---

## 📊 预期结果

### 应该看到的表

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| `sync_rooms` | 房间信息 | room_code, room_name, host_user_id, video_source |
| `sync_room_members` | 房间成员 | room_id, user_id, joined_at |
| `sync_room_messages` | 聊天消息 | room_id, user_id, message, created_at |

### 表结构验证

**sync_rooms 表**：
```sql
CREATE TABLE `sync_rooms` (
  `id` int NOT NULL AUTO_INCREMENT,
  `room_code` varchar(20) NOT NULL,
  `room_name` varchar(100) NOT NULL,
  `host_user_id` int NOT NULL,
  `control_mode` varchar(20) NOT NULL DEFAULT 'host_only',
  `mode` varchar(20) NOT NULL DEFAULT 'link',
  `video_source` text,
  `video_hash` varchar(64) DEFAULT NULL,
  `current_time` int DEFAULT '0',
  `is_playing` tinyint(1) DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `room_code` (`room_code`),
  KEY `idx_room_code` (`room_code`),
  KEY `idx_host_user` (`host_user_id`),
  KEY `idx_active` (`is_active`),
  CONSTRAINT `sync_rooms_ibfk_1` FOREIGN KEY (`host_user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 🐛 常见问题

### 问题1：外键约束错误

**错误信息**：
```
Cannot add foreign key constraint
```

**原因**：`users` 表不存在或结构不匹配

**解决方法**：

1. **检查 users 表是否存在**：
```sql
USE blue_local_db;
SHOW TABLES LIKE 'users';
```

2. **检查 users 表结构**：
```sql
DESCRIBE users;
```

3. **确保 users 表有 id 字段**：
```sql
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_KEY 
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = 'blue_local_db' 
  AND TABLE_NAME = 'users' 
  AND COLUMN_NAME = 'id';
```

---

### 问题2：表已存在

**错误信息**：
```
Table 'sync_rooms' already exists
```

**解决方法**：

**选项A**：跳过创建（表已存在是正常的）

**选项B**：删除旧表重新创建（⚠️ 会丢失数据）
```sql
USE blue_local_db;

DROP TABLE IF EXISTS sync_room_messages;
DROP TABLE IF EXISTS sync_room_members;
DROP TABLE IF EXISTS sync_rooms;

-- 然后重新执行创建脚本
```

---

### 问题3：字符集错误

**错误信息**：
```
Unknown character set: 'utf8mb4'
```

**解决方法**：

检查 MySQL 版本：
```sql
SELECT VERSION();
```

如果版本低于 5.5，改用 utf8：
```sql
-- 在创建表语句中将
ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
-- 改为
ENGINE=InnoDB DEFAULT CHARSET=utf8
```

---

## 🧪 测试数据

创建表后，可以插入测试数据：

```sql
USE blue_local_db;

-- 假设已有用户 ID=1
-- 插入测试房间
INSERT INTO sync_rooms (room_code, room_name, host_user_id, control_mode, mode, video_source)
VALUES 
    ('TEST01', '测试房间1', 1, 'host_only', 'link', 'https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/360/Big_Buck_Bunny_360_10s_1MB.mp4'),
    ('TEST02', '测试房间2', 1, 'all_members', 'link', 'https://www.w3schools.com/html/mov_bbb.mp4');

-- 查看房间
SELECT * FROM sync_rooms;

-- 加入测试成员
INSERT INTO sync_room_members (room_id, user_id)
VALUES (1, 1);

-- 插入测试消息
INSERT INTO sync_room_messages (room_id, user_id, message)
VALUES (1, 1, '这是一条测试消息');

-- 查看完整数据
SELECT 
    r.id,
    r.room_code,
    r.room_name,
    r.control_mode,
    COUNT(DISTINCT m.user_id) as member_count,
    COUNT(msg.id) as message_count
FROM sync_rooms r
LEFT JOIN sync_room_members m ON r.id = m.room_id
LEFT JOIN sync_room_messages msg ON r.id = msg.room_id
GROUP BY r.id;
```

---

## ✅ 完成检查清单

创建表后，确认以下内容：

- [ ] ✅ 数据库 `blue_local_db` 存在
- [ ] ✅ `sync_rooms` 表已创建
- [ ] ✅ `sync_room_members` 表已创建
- [ ] ✅ `sync_room_messages` 表已创建
- [ ] ✅ 所有外键约束正常
- [ ] ✅ 可以插入测试数据
- [ ] ✅ 可以查询数据

---

## 🚀 下一步

表创建完成后：

1. **重启后端服务**（如果正在运行）
2. **测试创建房间功能**
3. **测试加入房间功能**
4. **测试聊天功能**
5. **测试进度条同步**

---

## 📝 相关文件

- 完整迁移脚本：`backend/migrations/sync_rooms_migration.sql`
- 快速创建脚本：`backend/migrations/快速创建同步观影表.sql`
- 后端模型定义：`backend/models.py`
- WebSocket 服务：`backend/websocket_server.py`

---

**现在可以在 HeidiSQL 中执行创建脚本了！**

执行后告诉我结果，如果遇到错误，提供完整的错误信息。
