# ✅ 数据库表创建 - 一键执行

## 📝 数据库信息
- **数据库名**: `blue_local_db`  ✅ 已更正
- **需要创建**: 3个表

---

## 🚀 立即执行（复制粘贴到 HeidiSQL）

### 步骤1：打开 HeidiSQL 查询窗口

点击工具栏的 **"查询"** 按钮或按 **F9**

### 步骤2：复制粘贴以下 SQL 并执行

```sql
-- ===========================================
-- 同步观影功能 - 数据库表创建
-- 数据库: blue_local_db
-- ===========================================

USE blue_local_db;

-- 创建房间表
CREATE TABLE IF NOT EXISTS sync_rooms (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_code VARCHAR(20) UNIQUE NOT NULL,
    room_name VARCHAR(100) NOT NULL,
    host_user_id INT NOT NULL,
    control_mode VARCHAR(20) DEFAULT 'host_only' NOT NULL,
    mode VARCHAR(20) DEFAULT 'link' NOT NULL,
    video_source TEXT,
    video_hash VARCHAR(64),
    current_time INT DEFAULT 0,
    is_playing BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (host_user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_room_code (room_code),
    INDEX idx_host_user (host_user_id),
    INDEX idx_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建成员表
CREATE TABLE IF NOT EXISTS sync_room_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_id INT NOT NULL,
    user_id INT NOT NULL,
    nickname VARCHAR(50),
    is_verified BOOLEAN DEFAULT TRUE,
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (room_id) REFERENCES sync_rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_room_member (room_id, user_id),
    INDEX idx_room_member (room_id, user_id),
    INDEX idx_user_rooms (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建消息表
CREATE TABLE IF NOT EXISTS sync_room_messages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_id INT NOT NULL,
    user_id INT NOT NULL,
    message TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (room_id) REFERENCES sync_rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_room_messages (room_id, created_at),
    INDEX idx_user_messages (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 验证创建结果
SELECT 
    TABLE_NAME as '表名',
    TABLE_ROWS as '行数',
    CREATE_TIME as '创建时间'
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'blue_local_db' 
  AND TABLE_NAME IN ('sync_rooms', 'sync_room_members', 'sync_room_messages');
```

### 步骤3：查看结果

执行后应该看到：

```
表名                    | 行数 | 创建时间
-----------------------|------|------------------
sync_rooms             | 0    | 2025-10-19 XX:XX:XX
sync_room_members      | 0    | 2025-10-19 XX:XX:XX
sync_room_messages     | 0    | 2025-10-19 XX:XX:XX
```

---

## ✅ 成功标志

如果看到：
- ✅ **3个表都显示出来**
- ✅ **没有报错**
- ✅ **行数为 0**（新表）

说明创建成功！

---

## ❌ 如果遇到错误

### 错误1：数据库不存在

```
Unknown database 'blue_local_db'
```

**解决**：先创建数据库
```sql
CREATE DATABASE IF NOT EXISTS blue_local_db 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE blue_local_db;
```

### 错误2：users 表不存在

```
Cannot add foreign key constraint
```

**解决**：确认 users 表存在
```sql
SHOW TABLES LIKE 'users';
-- 如果没有 users 表，需要先创建主应用的基础表
```

### 错误3：表已存在

```
Table 'sync_rooms' already exists
```

**这不是错误！** 使用了 `IF NOT EXISTS`，表已存在会自动跳过。

---

## 🎯 下一步

表创建后：

1. ✅ **刷新 HeidiSQL** 左侧表列表
2. ✅ **重启后端服务**（如果正在运行）
3. ✅ **测试创建房间功能**

---

**执行完成后告诉我结果！** 🎉
