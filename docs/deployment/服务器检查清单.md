# Blue Album 服务器部署检查清单

## 📋 需要检查和提供的信息

### 1. 服务器基本信息
```bash
# 1.1 系统信息
uname -a
cat /etc/os-release

# 1.2 已安装的软件版本
nginx -v
python3 --version
mysql --version
docker --version  # 如果使用 Docker
```

### 2. 项目目录结构
```bash
# 2.1 查看项目根目录
ls -la /home/wwwroot/blue-album.top/

# 2.2 查看前端目录
ls -la /home/wwwroot/blue-album.top/frontend/
ls -la /home/wwwroot/blue-album.top/frontend/dist/

# 2.3 查看后端目录
ls -la /home/wwwroot/blue-album.top/backend/

# 2.4 查看配置文件
ls -la /home/wwwroot/blue-album.top/.env
cat /home/wwwroot/blue-album.top/.env  # 检查环境变量
```

### 3. 服务运行状态
```bash
# 3.1 检查后端进程
ps aux | grep uvicorn
ps aux | grep python

# 3.2 检查端口占用
netstat -tulpn | grep 8000  # 后端端口
netstat -tulpn | grep 3306  # MySQL 端口
netstat -tulpn | grep 80    # HTTP 端口
netstat -tulpn | grep 443   # HTTPS 端口

# 3.3 如果使用 Docker
docker ps
docker-compose ps
```

### 4. 数据库状态
```bash
# 4.1 检查 MySQL 服务
systemctl status mysql

# 4.2 检查数据库
mysql -u root -p
# 然后执行：
SHOW DATABASES;
USE blue_local_db;  # 或 blue_album
SHOW TABLES;
EXIT;
```

### 5. Nginx 配置
```bash
# 5.1 检查 Nginx 配置语法
nginx -t

# 5.2 查看当前配置
cat /usr/local/nginx/conf/vhost/blue-album.top.conf

# 5.3 查看 Nginx 状态
systemctl status nginx
# 或
ps aux | grep nginx
```

### 6. 日志文件
```bash
# 6.1 Nginx 日志
tail -f /home/wwwlogs/blue-album.top.log
tail -f /home/wwwlogs/blue-album.top-error.log

# 6.2 后端日志（如果有）
tail -f /home/wwwroot/blue-album.top/logs/backend.log

# 6.3 系统日志
journalctl -u nginx -f
journalctl -u blue-album-backend -f  # 如果使用 systemd
```

### 7. 权限检查
```bash
# 7.1 检查文件所有者
ls -la /home/wwwroot/blue-album.top/

# 7.2 检查 Nginx 运行用户
ps aux | grep nginx | grep -v grep

# 7.3 确保权限正确
# Nginx 用户（通常是 www 或 nginx）需要读取权限
chown -R www:www /home/wwwroot/blue-album.top/
# 或
chown -R nginx:nginx /home/wwwroot/blue-album.top/
```

### 8. 防火墙和安全组
```bash
# 8.1 检查防火墙规则
iptables -L -n
# 或
firewall-cmd --list-all

# 8.2 确保端口开放
# HTTP (80), HTTPS (443) 必须开放
# 如果使用云服务器，还需要在控制台配置安全组
```

---

## 🔧 快速诊断命令（一键执行）

将以下内容保存为 `check-server.sh`，然后执行：

```bash
#!/bin/bash
echo "================================"
echo "Blue Album 服务器诊断报告"
echo "================================"
echo ""

echo "=== 1. 系统信息 ==="
uname -a
echo ""

echo "=== 2. 软件版本 ==="
echo -n "Nginx: "; nginx -v 2>&1 | awk '{print $3}'
echo -n "Python: "; python3 --version
echo -n "MySQL: "; mysql --version | awk '{print $5}' | cut -d',' -f1
echo ""

echo "=== 3. 项目目录 ==="
ls -lh /home/wwwroot/blue-album.top/ | grep -E "^d|^-"
echo ""

echo "=== 4. 前端构建文件 ==="
if [ -d "/home/wwwroot/blue-album.top/frontend/dist" ]; then
    echo "✅ 前端 dist 目录存在"
    ls -lh /home/wwwroot/blue-album.top/frontend/dist/ | head -5
else
    echo "❌ 前端 dist 目录不存在！需要构建前端"
fi
echo ""

echo "=== 5. 环境变量 ==="
if [ -f "/home/wwwroot/blue-album.top/.env" ]; then
    echo "✅ .env 文件存在"
    echo "配置项："
    cat /home/wwwroot/blue-album.top/.env | grep -v "^#" | grep -v "^$" | cut -d'=' -f1
else
    echo "❌ .env 文件不存在！"
fi
echo ""

echo "=== 6. 服务运行状态 ==="
echo -n "后端进程: "
if ps aux | grep -v grep | grep uvicorn > /dev/null; then
    echo "✅ 运行中"
    ps aux | grep -v grep | grep uvicorn | awk '{print "  PID:"$2, "CPU:"$3"%", "MEM:"$4"%"}'
else
    echo "❌ 未运行"
fi

echo -n "MySQL: "
if systemctl is-active mysql > /dev/null 2>&1; then
    echo "✅ 运行中"
else
    echo "❌ 未运行"
fi

echo -n "Nginx: "
if systemctl is-active nginx > /dev/null 2>&1; then
    echo "✅ 运行中"
else
    echo "❌ 未运行"
fi
echo ""

echo "=== 7. 端口监听 ==="
netstat -tulpn | grep -E ":(80|443|3306|8000)\s"
echo ""

echo "=== 8. 数据库 ==="
echo "SHOW DATABASES LIKE 'blue_%';" | mysql -u root 2>/dev/null || echo "⚠️  需要 MySQL 密码"
echo ""

echo "=== 9. Nginx 配置检查 ==="
nginx -t 2>&1
echo ""

echo "=== 10. 最近错误日志（最后10行）==="
if [ -f "/home/wwwlogs/blue-album.top-error.log" ]; then
    tail -10 /home/wwwlogs/blue-album.top-error.log
else
    echo "无错误日志"
fi
echo ""

echo "================================"
echo "诊断完成！"
echo "================================"
```

使用方法：
```bash
# 上传到服务器
scp check-server.sh root@your-server-ip:/root/

# SSH 登录服务器
ssh root@your-server-ip

# 执行检查
chmod +x check-server.sh
./check-server.sh
```

---

## 📤 请提供以下输出

**方式一：运行诊断脚本**
```bash
bash check-server.sh > server-status.txt 2>&1
cat server-status.txt
```

**方式二：手动执行关键命令**
至少需要这些：
```bash
# 1. 项目目录结构
ls -la /home/wwwroot/blue-album.top/

# 2. 前端是否构建
ls /home/wwwroot/blue-album.top/frontend/dist/

# 3. 后端运行状态
ps aux | grep uvicorn

# 4. 端口占用
netstat -tulpn | grep 8000

# 5. .env 配置（隐藏密码）
cat /home/wwwroot/blue-album.top/.env | grep -v PASSWORD | grep -v SECRET
```

---

把上面命令的输出发给我，我就能给你完整的部署方案了！ 🚀
