# 🚀 同步观影功能 - 快速诊断和修复

## 问题：进度条同步和聊天功能无效

---

## 🔍 第一步：打开浏览器控制台

按 `F12` 打开开发者工具，然后粘贴并执行以下诊断脚本：

```javascript
// ==================== 诊断脚本 ====================
console.clear();
console.log('%c========== 同步观影功能诊断 ==========', 'color: #00ff00; font-size: 16px; font-weight: bold');

// 1. 检查环境
console.log('%c1️⃣ 检查环境', 'color: #3498db; font-size: 14px; font-weight: bold');
console.log('当前 URL:', window.location.href);
console.log('User Agent:', navigator.userAgent);

// 2. 检查 Socket.IO 库
console.log('%c2️⃣ 检查 Socket.IO 库', 'color: #3498db; font-size: 14px; font-weight: bold');
console.log('io 对象存在:', typeof io !== 'undefined');
if (typeof io !== 'undefined') {
  console.log('✅ Socket.IO 已加载');
} else {
  console.error('❌ Socket.IO 未加载！');
}

// 3. 检查 Vue 组件状态（需要在播放器页面）
if (window.location.href.includes('/tools/sync-room/')) {
  console.log('%c3️⃣ 检查组件状态', 'color: #3498db; font-size: 14px; font-weight: bold');
  
  // 尝试获取 Vue 实例（通过开发者工具）
  setTimeout(() => {
    const app = document.querySelector('#app').__vue_app__;
    if (app) {
      console.log('✅ Vue 应用已挂载');
      
      // 检查关键数据
      console.log('%c4️⃣ 检查关键数据', 'color: #3498db; font-size: 14px; font-weight: bold');
      
      // 提示用户手动检查
      console.log('%c请在 Console 中手动执行以下命令检查状态:', 'color: #f39c12; font-weight: bold');
      console.log('%c  socket.value', 'color: #95a5a6');
      console.log('%c  socket.value?.connected', 'color: #95a5a6');
      console.log('%c  currentUserId.value', 'color: #95a5a6');
      console.log('%c  currentUsername.value', 'color: #95a5a6');
      console.log('%c  roomId.value', 'color: #95a5a6');
      console.log('%c  roomInfo.value', 'color: #95a5a6');
    }
  }, 1000);
}

// 5. 检查网络连接
console.log('%c5️⃣ 检查网络连接', 'color: #3498db; font-size: 14px; font-weight: bold');
fetch('http://localhost:8000/ws/socket.io/')
  .then(response => {
    if (response.ok) {
      console.log('✅ WebSocket 服务端点可访问');
    } else {
      console.error('❌ WebSocket 服务端点返回错误:', response.status);
    }
  })
  .catch(error => {
    console.error('❌ 无法连接到 WebSocket 服务:', error.message);
    console.log('💡 解决方法：确保后端服务运行在 http://localhost:8000');
  });

// 6. 检查认证
console.log('%c6️⃣ 检查认证状态', 'color: #3498db; font-size: 14px; font-weight: bold');
const token = localStorage.getItem('auth-token');
if (token) {
  console.log('✅ Token 存在');
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    console.log('Token 信息:', payload);
  } catch (e) {
    console.error('❌ Token 解析失败');
  }
} else {
  console.error('❌ 未找到 Token，请先登录');
}

console.log('%c========== 诊断完成 ==========', 'color: #00ff00; font-size: 16px; font-weight: bold');
console.log('%c如果看到 ❌，请按照提示修复问题', 'color: #e74c3c; font-weight: bold');
```

---

## 🛠️ 第二步：根据诊断结果修复

### 情况A：❌ Socket.IO 未加载

**原因**：前端依赖未安装

**解决**：
```bash
cd d:\Laragon\laragon\www\blue-local\frontend
npm install socket.io-client
```

然后重启前端服务。

---

### 情况B：❌ WebSocket 服务端点不可访问

**原因1**：后端未运行

**解决**：
```bash
cd d:\Laragon\laragon\www\blue-local
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

**原因2**：WebSocket 未挂载

**检查**：打开 `backend/main.py`，确认文件**末尾**有：
```python
# 在所有路由之后
app.mount("/ws", socket_app)
```

---

### 情况C：❌ 未找到 Token

**原因**：用户未登录

**解决**：
1. 访问 `http://localhost:5173/login`
2. 登录账号
3. 返回同步观影页面

---

### 情况D：✅ 所有检查都通过，但功能仍不工作

**进一步诊断**：在播放器页面的控制台执行：

```javascript
// 检查 Socket 连接状态
console.log('=== Socket 状态 ===');
console.log('socket 对象:', socket.value);
console.log('已连接:', socket.value?.connected);
console.log('Socket ID:', socket.value?.id);

// 检查用户信息
console.log('=== 用户信息 ===');
console.log('用户 ID:', currentUserId.value);
console.log('用户名:', currentUsername.value);

// 检查房间信息
console.log('=== 房间信息 ===');
console.log('房间 ID:', roomId.value);
console.log('房间信息:', roomInfo.value);
console.log('是否房主:', isHost.value);
console.log('可否控制:', canControl.value);

// 手动测试发送播放命令
console.log('=== 测试播放控制 ===');
if (socket.value && socket.value.connected) {
  socket.value.emit('playback_control', {
    room_id: parseInt(roomId.value),
    user_id: currentUserId.value,
    action: 'play'
  });
  console.log('✅ 已发送播放命令，查看是否收到 playback_sync 事件');
} else {
  console.error('❌ Socket 未连接');
}

// 监听 playback_sync 事件
socket.value?.on('playback_sync', (data) => {
  console.log('✅ 收到同步事件:', data);
});

// 手动测试发送消息
console.log('=== 测试聊天功能 ===');
if (socket.value && socket.value.connected) {
  socket.value.emit('send_message', {
    room_id: parseInt(roomId.value),
    user_id: currentUserId.value,
    username: currentUsername.value,
    message: '这是一条测试消息'
  });
  console.log('✅ 已发送测试消息，查看是否收到 new_message 事件');
} else {
  console.error('❌ Socket 未连接');
}

// 监听 new_message 事件
socket.value?.on('new_message', (data) => {
  console.log('✅ 收到新消息:', data);
});
```

---

## 🎯 第三步：常见问题修复

### 问题1：Socket 未连接

**症状**：`socket.value?.connected` 返回 `false` 或 `undefined`

**可能原因**：
1. WebSocket URL 错误
2. 后端服务未运行
3. CORS 配置问题

**修复**：

检查 `frontend/src/views/SyncRoomPlayer.vue` 中的 WebSocket URL：
```javascript
socket.value = io('http://localhost:8000/ws', {
  transports: ['websocket', 'polling'],
  reconnection: true,
  reconnectionDelay: 1000,
  reconnectionAttempts: 5
});
```

确保：
- ✅ URL 是 `http://localhost:8000/ws`
- ✅ 后端在 8000 端口运行
- ✅ 路径是 `/ws` 不是 `/api/ws`

---

### 问题2：currentUserId 或 currentUsername 为 undefined

**症状**：控制台显示 `undefined`

**可能原因**：authStore 未正确初始化

**修复**：

检查 `SyncRoomPlayer.vue` 中的代码：
```javascript
import { useAuthStore } from '../stores/auth';

const authStore = useAuthStore();
const currentUserId = computed(() => authStore.user?.id);
const currentUsername = computed(() => authStore.user?.username);
```

如果还是 undefined，尝试：
```javascript
// 在组件 onMounted 中添加
onMounted(async () => {
  // 确保 user 信息加载
  if (!authStore.user) {
    await authStore.fetchUser();  // 如果有这个方法
  }
  
  console.log('当前用户:', authStore.user);
  
  // ... 其他初始化代码
});
```

---

### 问题3：数据库表不存在

**症状**：后端日志显示数据库错误

**修复**：

在 HeidiSQL 中执行：
```sql
USE blue_local;

-- 检查表
SHOW TABLES LIKE 'sync_rooms%';

-- 如果没有表，执行迁移
SOURCE D:\Laragon\laragon\www\blue-local\backend\migrations\sync_rooms_migration.sql;
```

---

### 问题4：视频播放器事件未触发

**症状**：点击播放/暂停没有反应

**可能原因**：`isUpdating` 标志阻止了事件

**临时修复**：在控制台执行
```javascript
// 重置标志
isUpdating = false;

// 强制发送播放命令
socket.value.emit('playback_control', {
  room_id: parseInt(roomId.value),
  user_id: currentUserId.value,
  action: 'play'
});
```

---

## 🚑 紧急重置步骤

如果所有方法都失败，执行完整重置：

### 1. 停止所有服务
- 关闭前端终端（Ctrl+C）
- 关闭后端终端（Ctrl+C）

### 2. 清除缓存
```bash
# 清除浏览器缓存
# 按 Ctrl+Shift+Delete，选择"缓存"

# 清除前端构建缓存
cd d:\Laragon\laragon\www\blue-local\frontend
rmdir /s /q node_modules\.vite
rmdir /s /q dist
```

### 3. 重新安装依赖
```bash
cd d:\Laragon\laragon\www\blue-local\frontend
npm install socket.io-client element-plus
```

### 4. 确认数据库表
```sql
USE blue_local;
SOURCE D:\Laragon\laragon\www\blue-local\backend\migrations\sync_rooms_migration.sql;
```

### 5. 重启服务
```bash
# 后端
cd d:\Laragon\laragon\www\blue-local
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000

# 前端（新终端）
cd d:\Laragon\laragon\www\blue-local\frontend
npm run dev
```

### 6. 清除本地存储
在浏览器控制台：
```javascript
// 保存 token
const token = localStorage.getItem('auth-token');

// 清除所有
localStorage.clear();

// 恢复 token
if (token) localStorage.setItem('auth-token', token);

// 刷新页面
location.reload();
```

---

## 📞 获取帮助

如果问题仍未解决，请提供：

1. **浏览器控制台的完整输出**（Console 标签）
2. **网络请求日志**（Network 标签，筛选 WS 和 XHR）
3. **后端终端的日志**（特别是包含 ERROR 的行）
4. **数据库表列表**：
   ```sql
   USE blue_local;
   SHOW TABLES;
   ```

---

**下一步**：请执行诊断脚本，并告诉我看到了什么 ❌ 标记。
