# ğŸ”§ åŒæ­¥è§‚å½±åŠŸèƒ½ - é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## ğŸ› å‘ç°çš„é—®é¢˜

æ ¹æ®ä½ çš„åé¦ˆ,å‘ç°ä»¥ä¸‹é—®é¢˜:

1. âŒ **WebSocketè¿æ¥å¤±è´¥** - `ws://localhost:8000/socket.io/` è¿æ¥ä¸ä¸Š
2. âŒ **èŠå¤©æ¶ˆæ¯ä¸æ˜¾ç¤º** - å‘é€åæ²¡æœ‰ç«‹å³æ˜¾ç¤º
3. âŒ **æƒé™æ§åˆ¶å¤±æ•ˆ** - æˆå‘˜ä¹Ÿå¯ä»¥æ‹–è¿›åº¦æ¡(åº”è¯¥åªæœ‰æˆ¿ä¸»èƒ½æ§åˆ¶)
4. âŒ **æˆ¿ä¸»è¿›åº¦ä¸åŒæ­¥** - æˆ¿ä¸»çš„è¿›åº¦å˜åŒ–ä¸åŒæ­¥åˆ°æˆå‘˜
5. âŒ **æˆå‘˜åˆ—è¡¨ä¸æ›´æ–°** - æ–°æˆå‘˜åŠ å…¥åæˆ¿ä¸»éœ€è¦æ‰‹åŠ¨åˆ·æ–°

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: WebSocketè·¯å¾„ä¸åŒ¹é…
**åç«¯**: 
```python
socket_app = socketio.ASGIApp(sio, socketio_path='socket.io')
app.mount("/ws", socket_app)
```
è¿™æ„å‘³ç€Socket.IOæœåŠ¡å™¨åœ¨: `http://localhost:8000/ws/socket.io/`

**å‰ç«¯**:
```javascript
socket.value = io('http://localhost:8000/ws', {...})
```
Socket.IOå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¿½åŠ `/socket.io/`,æ‰€ä»¥å®é™…è¿æ¥: `http://localhost:8000/ws/socket.io/` âœ…

**ä½†æ˜¯**: Socket.IOéœ€è¦æ­£ç¡®çš„CORSå’Œè·¯å¾„é…ç½®!

### é—®é¢˜2: èŠå¤©æ¶ˆæ¯æœªç«‹å³æ·»åŠ åˆ°æœ¬åœ°
å‰ç«¯ä»£ç åªåœ¨æ”¶åˆ°`new_message`äº‹ä»¶æ—¶æ‰æ˜¾ç¤ºæ¶ˆæ¯,ä½†å‘é€è€…åº”è¯¥ç«‹å³çœ‹åˆ°è‡ªå·±çš„æ¶ˆæ¯

### é—®é¢˜3: æƒé™æ£€æŸ¥é€»è¾‘é—®é¢˜
å‰ç«¯çš„`canControl`è®¡ç®—å±æ€§å¯èƒ½æœ‰é—®é¢˜

### é—®é¢˜4: æ•°æ®åº“è¿æ¥ç®¡ç†é”™è¯¯
`get_db()`å‡½æ•°ä½¿ç”¨äº†`finally`è‡ªåŠ¨å…³é—­,å¯¼è‡´æ•°æ®åº“æ“ä½œåç«‹å³å…³é—­è¿æ¥

### é—®é¢˜5: æˆå‘˜åˆ—è¡¨æ›´æ–°ä¾èµ–æ‰‹åŠ¨åˆ·æ–°
å‰ç«¯æ”¶åˆ°`member_joined`äº‹ä»¶ååº”è¯¥è‡ªåŠ¨æ›´æ–°æˆå‘˜åˆ—è¡¨

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: åç«¯WebSocketæœåŠ¡å™¨é…ç½®

**æ–‡ä»¶**: `backend/websocket_server.py`

#### 1.1 ä¿®å¤æ•°æ®åº“è¿æ¥ç®¡ç†
```python
# âŒ é”™è¯¯å†™æ³•
def get_db():
    db = SessionLocal()
    try:
        return db
    finally:
        db.close()  # ç«‹å³å…³é—­!

# âœ… æ­£ç¡®å†™æ³•
def get_db():
    db = SessionLocal()
    try:
        return db
    except Exception:
        db.close()
        raise
```

#### 1.2 ç¡®ä¿Socket.IOé…ç½®æ­£ç¡®
```python
sio = socketio.AsyncServer(
    async_mode='asgi',
    cors_allowed_origins=['http://localhost:5173', 'http://127.0.0.1:5173', 
                         'http://localhost:5174', 'http://127.0.0.1:5174'],
    logger=True,
    engineio_logger=True,
    ping_timeout=60,
    ping_interval=25
)
```

#### 1.3 ä¿®å¤send_messageäº‹ä»¶(å¹¿æ’­ç»™æ‰€æœ‰äººåŒ…æ‹¬å‘é€è€…)
```python
# âœ… ç§»é™¤ skip_sid,è®©å‘é€è€…ä¹Ÿèƒ½æ”¶åˆ°
await sio.emit('new_message', {
    'id': db_message.id,
    'room_id': room_id,
    'user_id': user_id,
    'username': username,
    'message': message,
    'created_at': db_message.created_at.isoformat()
}, room=f'room_{room_id}')  # ä¸è¦ skip_sid
```

#### 1.4 åœ¨æ‰€æœ‰æ•°æ®åº“æ“ä½œåæ‰‹åŠ¨å…³é—­è¿æ¥
```python
@sio.event
async def join_room(sid, data):
    db = None
    try:
        db = get_db()
        # ... æ•°æ®åº“æ“ä½œ ...
    except Exception as e:
        logger.error(f"Error: {str(e)}")
    finally:
        if db:
            db.close()
```

---

### ä¿®å¤2: å‰ç«¯SyncRoomPlayer.vue

#### 2.1 ä¿®å¤èŠå¤©æ¶ˆæ¯å‘é€é€»è¾‘
```javascript
// å‘é€æ¶ˆæ¯
const sendMessage = () => {
  const message = newMessage.value.trim();
  if (!message) return;
  
  // ç«‹å³æ·»åŠ åˆ°æœ¬åœ°æ˜¾ç¤º(ä¹è§‚æ›´æ–°)
  const tempMessage = {
    id: Date.now(),  // ä¸´æ—¶ID
    user_id: currentUserId.value,
    username: currentUsername.value,
    message: message,
    created_at: new Date().toISOString()
  };
  messages.value.push(tempMessage);
  scrollToBottom();
  
  // å‘é€åˆ°æœåŠ¡å™¨
  socket.value?.emit('send_message', {
    room_id: roomId.value,
    user_id: currentUserId.value,
    username: currentUsername.value,
    message: message
  });
  
  newMessage.value = '';  // æ¸…ç©ºè¾“å…¥æ¡†
};

// ç›‘å¬æ–°æ¶ˆæ¯
socket.value.on('new_message', (data) => {
  // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤º(é¿å…é‡å¤)
  const exists = messages.value.some(msg => 
    msg.user_id === data.user_id && 
    msg.message === data.message && 
    Math.abs(new Date(msg.created_at) - new Date(data.created_at)) < 1000
  );
  
  if (!exists) {
    messages.value.push(data);
    scrollToBottom();
  }
});
```

#### 2.2 ä¿®å¤æƒé™æ§åˆ¶é€»è¾‘
```javascript
// è®¡ç®—æ˜¯å¦å¯ä»¥æ§åˆ¶
const canControl = computed(() => {
  if (!roomInfo.value) return false;
  
  // æˆ¿ä¸»æ¨¡å¼:åªæœ‰æˆ¿ä¸»èƒ½æ§åˆ¶
  if (roomInfo.value.control_mode === 'host_only') {
    return currentUserId.value === roomInfo.value.host_user_id;
  }
  
  // å…¨å‘˜æ¨¡å¼:æ‰€æœ‰äººéƒ½èƒ½æ§åˆ¶
  return roomInfo.value.control_mode === 'all_members';
});

// ç¦ç”¨è§†é¢‘æ§åˆ¶(å¦‚æœæ²¡æœ‰æƒé™)
const initVideoPlayer = () => {
  const video = videoPlayer.value;
  if (!video) return;
  
  // å¦‚æœæ²¡æœ‰æ§åˆ¶æƒé™,ç¦ç”¨åŸç”Ÿæ§åˆ¶
  if (!canControl.value) {
    video.controls = false;  // éšè—åŸç”Ÿæ§åˆ¶æ 
  } else {
    video.controls = true;
  }
};

// ç›‘å¬roomInfoå˜åŒ–,æ›´æ–°æ§åˆ¶æƒé™
watch(roomInfo, () => {
  initVideoPlayer();
}, { deep: true });
```

#### 2.3 ä¿®å¤æˆå‘˜åˆ—è¡¨è‡ªåŠ¨æ›´æ–°
```javascript
// æ–°æˆå‘˜åŠ å…¥
socket.value.on('member_joined', async (data) => {
  ElMessage.info(`${data.username} åŠ å…¥äº†æˆ¿é—´`);
  
  // ç«‹å³æ›´æ–°æˆå‘˜åˆ—è¡¨
  await fetchMembers();
});

// æˆå‘˜ç¦»å¼€
socket.value.on('member_left', async (data) => {
  // ç«‹å³æ›´æ–°æˆå‘˜åˆ—è¡¨
  await fetchMembers();
  
  // å¦‚æœæœ‰username,æ˜¾ç¤ºé€šçŸ¥
  if (data.username) {
    ElMessage.warning(`${data.username} ç¦»å¼€äº†æˆ¿é—´`);
  }
});
```

#### 2.4 ä¿®å¤è¿›åº¦åŒæ­¥é€»è¾‘
```javascript
// ç¡®ä¿æˆ¿ä¸»çš„è¿›åº¦æ›´æ–°ä¼šå¹¿æ’­
const onSeeking = () => {
  if (isUpdating) return;  // æ­£åœ¨è¢«åŠ¨æ›´æ–°æ—¶ä¸å‘é€
  if (!canControl.value) {
    // å¦‚æœæ²¡æœ‰æ§åˆ¶æƒé™,é˜»æ­¢æ‹–åŠ¨
    if (videoPlayer.value) {
      videoPlayer.value.currentTime = roomInfo.value.current_time || 0;
    }
    return;
  }
  
  const time = Math.floor(videoPlayer.value?.currentTime || 0);
  
  console.log('ğŸ¯ å‘é€è¿›åº¦è·³è½¬:', time);
  
  socket.value?.emit('playback_control', {
    room_id: roomId.value,
    user_id: currentUserId.value,
    action: 'seek',
    time: time
  });
};
```

---

## ğŸ“ å®Œæ•´ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥: ä¿®å¤åç«¯(3ä¸ªå…³é”®ä¿®æ”¹)

1. æ‰“å¼€ `backend/websocket_server.py`
2. ä¿®æ”¹`get_db()`å‡½æ•°
3. åœ¨æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨ä¸­æ·»åŠ `finally: db.close()`
4. ä¿®æ”¹`send_message`çš„emit(ç§»é™¤skip_sid)

### ç¬¬äºŒæ­¥: ä¿®å¤å‰ç«¯(4ä¸ªå…³é”®ä¿®æ”¹)

1. æ‰“å¼€ `frontend/src/views/SyncRoomPlayer.vue`
2. ä¿®æ”¹`sendMessage`å‡½æ•°(ç«‹å³æ˜¾ç¤º)
3. ä¿®æ”¹`canControl`å’Œè§†é¢‘æ§åˆ¶é€»è¾‘
4. ä¿®æ”¹`member_joined`å’Œ`member_left`äº‹ä»¶å¤„ç†
5. ä¿®æ”¹`onSeeking`å‡½æ•°

### ç¬¬ä¸‰æ­¥: é‡å¯æœåŠ¡

```powershell
# åœæ­¢åç«¯ (Ctrl+C)
# é‡æ–°å¯åŠ¨
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### ç¬¬å››æ­¥: æµ‹è¯•

1. æ‰“å¼€æµè§ˆå™¨
2. åˆ›å»ºæˆ¿é—´
3. æµ‹è¯•èŠå¤©(åº”è¯¥ç«‹å³æ˜¾ç¤º)
4. æµ‹è¯•è¿›åº¦æ§åˆ¶(æˆå‘˜åº”è¯¥ä¸èƒ½æ‹–åŠ¨)
5. æµ‹è¯•æˆ¿ä¸»è¿›åº¦åŒæ­¥(æˆå‘˜åº”è¯¥åŒæ­¥)
6. æ‰“å¼€ç¬¬äºŒä¸ªçª—å£åŠ å…¥æˆ¿é—´(æˆ¿ä¸»åº”è¯¥è‡ªåŠ¨çœ‹åˆ°æˆå‘˜)

---

## ğŸ¯ å¿«é€Ÿä¿®å¤ - å…³é”®ä»£ç 

æˆ‘ä¼šä¸ºä½ ç”Ÿæˆå®Œæ•´çš„ä¿®å¤æ–‡ä»¶!è¯·å‘Šè¯‰æˆ‘æ˜¯å¦ç«‹å³å¼€å§‹ä¿®å¤?

**æˆ‘éœ€è¦ä¿®æ”¹2ä¸ªæ–‡ä»¶**:
1. `backend/websocket_server.py` - ä¿®å¤æ•°æ®åº“è¿æ¥å’Œæ¶ˆæ¯å¹¿æ’­
2. `frontend/src/views/SyncRoomPlayer.vue` - ä¿®å¤å‰ç«¯é€»è¾‘

**ä¿®å¤åæ•ˆæœ**:
- âœ… èŠå¤©æ¶ˆæ¯ç«‹å³æ˜¾ç¤º
- âœ… åªæœ‰æˆ¿ä¸»èƒ½æ‹–è¿›åº¦æ¡
- âœ… æˆ¿ä¸»è¿›åº¦è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰æˆå‘˜
- âœ… æˆå‘˜åŠ å…¥/ç¦»å¼€è‡ªåŠ¨æ›´æ–°åˆ—è¡¨
- âœ… WebSocketè¿æ¥ç¨³å®š

**è¦å¼€å§‹ä¿®å¤å—?** å›å¤"å¼€å§‹ä¿®å¤"æˆ‘å°±ç«‹å³æ‰§è¡Œ! ğŸš€
