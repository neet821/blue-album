# 🏗️ 项目架构分析 - 第2部分

## 📐 架构设计模式

### 2.1 整体架构风格

**采用模式:** RESTful API + SPA (单页应用)

```
┌──────────────┐      HTTP/JSON      ┌──────────────┐
│              │ ◄─────────────────► │              │
│   Vue 3      │    RESTful API      │   FastAPI    │
│   (前端)     │                     │   (后端)     │
│              │                     │              │
└──────────────┘                     └───────┬──────┘
                                             │
                                             │ SQLAlchemy
                                             │
                                      ┌──────▼──────┐
                                      │    MySQL    │
                                      │  (数据库)   │
                                      └─────────────┘
```

**优点:**
- ✅ 前后端完全分离,职责清晰
- ✅ 可独立部署和扩展
- ✅ API 可复用(支持移动端、桌面端)

**缺点:**
- ⚠️ SEO 不友好(SPA 通病)
- ⚠️ 首屏加载慢
- ⚠️ 需要两个服务器

---

### 2.2 后端分层架构

```
┌─────────────────────────────────────┐
│        API Layer (main.py)          │  ← 路由定义、请求验证
├─────────────────────────────────────┤
│      Business Logic (crud.py)       │  ← 业务逻辑 ⚠️ 应独立
├─────────────────────────────────────┤
│     Data Access (SQLAlchemy)        │  ← ORM 映射
├─────────────────────────────────────┤
│         Database (MySQL)            │  ← 持久化存储
└─────────────────────────────────────┘
```

**当前问题:**
- ❌ 缺少 Service 层 - 业务逻辑混在 CRUD 中
- ❌ main.py 太臃肿 - 357 行路由代码
- ❌ 缺少中间件层 - 日志、监控、限流

**改进建议:**
```python
# 推荐结构
backend/
├── api/
│   ├── routes/
│   │   ├── auth.py      # 认证路由
│   │   ├── posts.py     # 文章路由
│   │   └── users.py     # 用户路由
│   └── dependencies.py  # 依赖注入
├── services/            # 业务逻辑层 ✨
│   ├── auth_service.py
│   └── post_service.py
├── repositories/        # 数据访问层 ✨
│   └── post_repo.py
└── core/
    ├── config.py        # 配置管理 ✨
    └── security.py
```

---

### 2.3 前端架构模式

**采用:** MVVM (Model-View-ViewModel)

```
┌──────────────┐
│   Component  │  ← View (模板)
│   Template   │
└──────┬───────┘
       │ 双向绑定
┌──────▼───────┐
│  Reactive    │  ← ViewModel (响应式状态)
│    Data      │
└──────┬───────┘
       │
┌──────▼───────┐
│  Pinia Store │  ← Model (数据模型)
│     API      │
└──────────────┘
```

**状态管理:**
- ✅ 使用 Pinia (轻量级)
- ✅ 模块化设计 (auth, theme)
- ⚠️ 缺少持久化插件

**路由设计:**
- ✅ 路由守卫 (认证检查)
- ✅ 懒加载组件
- ⚠️ 缺少路由元信息 (面包屑、标题)

---

## 🔌 API 设计分析

### 3.1 RESTful 规范遵守度

| 资源 | 方法 | 路径 | 符合度 |
|------|------|------|--------|
| 用户列表 | GET | `/api/admin/users` | ✅ 正确 |
| 单个用户 | GET | `/api/admin/users/{id}` | ✅ 正确 |
| 创建用户 | POST | `/api/users/register` | ⚠️ 应为 `/api/users` |
| 更新用户 | PUT | `/api/admin/users/{id}` | ✅ 正确 |
| 删除用户 | DELETE | `/api/admin/users/{id}` | ✅ 正确 |
| 文章列表 | GET | `/api/posts` | ✅ 正确 |
| 创建文章 | POST | `/api/posts` | ✅ 正确 |
| 登录 | POST | `/api/auth/login` | ✅ 正确 |

**总体评分:** ⭐⭐⭐⭐☆ (良好)

**改进建议:**
- 💡 `/api/users/register` → `/api/auth/register`
- 💡 统一命名规范 (users vs user)
- 💡 添加版本控制 `/api/v1/posts`

---

### 3.2 请求/响应设计

**请求示例 (创建文章):**
```json
POST /api/posts
Authorization: Bearer {token}

{
  "title": "文章标题",
  "content": "文章内容",
  "category": "技术"
}
```

**响应示例:**
```json
{
  "id": 1,
  "title": "文章标题",
  "content": "文章内容",
  "category": "技术",
  "views": 0,
  "author_id": 1,
  "created_at": "2025-10-19T10:00:00"
}
```

**优点:**
- ✅ JSON 格式标准
- ✅ 字段命名清晰
- ✅ 使用 Pydantic 验证

**缺点:**
- ❌ 缺少统一响应格式
- ❌ 错误响应不统一
- ❌ 缺少分页信息

**推荐格式:**
```json
{
  "code": 200,
  "message": "success",
  "data": { ... },
  "timestamp": 1729314000
}
```

---

### 3.3 认证授权机制

**当前实现:**
```
1. 用户登录 → 返回 JWT Token
2. 前端存储 Token (localStorage)
3. 每次请求携带 Token (Authorization: Bearer)
4. 后端验证 Token → 解码用户信息
5. 检查权限 (admin/user)
```

**安全措施:**
- ✅ 密码 bcrypt 加密
- ✅ JWT Token 认证
- ✅ Token 过期时间 (24小时)
- ✅ 401 自动登出
- ✅ 路由守卫

**安全风险:**
- ⚠️ Token 存储在 localStorage (XSS 风险)
- ⚠️ 缺少 CSRF 防护
- ⚠️ 缺少刷新 Token 机制
- ⚠️ 缺少 IP 限流

**改进建议:**
```javascript
// 使用 httpOnly Cookie
document.cookie = "token=xxx; HttpOnly; Secure; SameSite=Strict"

// 添加刷新 Token
{
  "access_token": "...",   // 15分钟
  "refresh_token": "...",  // 7天
}
```

---

**第二部分完成 ✅**

下一部分: 代码质量、性能优化、部署方案
