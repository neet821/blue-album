# ğŸš€ Blue Local æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## âœ… éƒ¨ç½²å‰å‡†å¤‡

### 1. æœ¬åœ°æµ‹è¯•ç¡®è®¤
åœ¨éƒ¨ç½²å‰ï¼Œè¯·ç¡®ä¿ä»¥ä¸‹åŠŸèƒ½éƒ½å·²åœ¨æœ¬åœ°æµ‹è¯•é€šè¿‡ï¼š

- [x] ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- [x] æ–‡ç« åˆ—è¡¨åŠ è½½
- [x] æ–‡ç« å‘å¸ƒ/ç¼–è¾‘/åˆ é™¤
- [x] åŒæ­¥è§‚å½±æˆ¿é—´åˆ›å»º
- [x] è§†é¢‘æ’­æ”¾åŒæ­¥ï¼ˆè¿›åº¦æ¡å»¶è¿Ÿ<1ç§’ï¼‰
- [x] æˆ¿ä¸»æ‹–åŠ¨è¿›åº¦æ¡æˆå‘˜åŒæ­¥
- [x] èŠå¤©åŠŸèƒ½
- [x] ç®¡ç†å‘˜åŠŸèƒ½

### 2. æœåŠ¡å™¨è¦æ±‚

**æœ€ä½é…ç½®ï¼š**
- CPU: 2æ ¸
- å†…å­˜: 4GB
- ç¡¬ç›˜: 20GB SSD
- ç³»ç»Ÿ: Ubuntu 20.04+ / CentOS 7+

**è½¯ä»¶è¦æ±‚ï¼š**
- Python 3.9+
- MySQL 8.0+
- Nginx
- Node.js 18+ (ä»…æ„å»ºæ—¶éœ€è¦)

## ğŸ“¦ æ–¹å¼ä¸€ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

### æ­¥éª¤1: æ‰“åŒ…é¡¹ç›®

åœ¨Windowsæœ¬åœ°è¿è¡Œï¼š
```bash
cd d:\Laragon\laragon\www\blue-local\scripts\deployment
package.bat
```

è¿™ä¼šç”Ÿæˆ `deploy-package` ç›®å½•ï¼ŒåŒ…å«ï¼š
- åç«¯ä»£ç 
- å‰ç«¯æ„å»ºäº§ç‰©
- éƒ¨ç½²è„šæœ¬
- æ•°æ®åº“è¿ç§»è„šæœ¬

### æ­¥éª¤2: ä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# å‹ç¼©æ‰“åŒ…ç›®å½•
7z a blue-local.zip deploy-package\*

# ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆä½¿ç”¨FTP/SFTPå·¥å…·ï¼Œæˆ–å‘½ä»¤è¡Œï¼‰
scp blue-local.zip user@your-server:/tmp/

# SSHè¿æ¥åˆ°æœåŠ¡å™¨
ssh user@your-server

# è§£å‹
cd /tmp
unzip blue-local.zip
sudo mv deploy-package /var/www/blue-local
```

### æ­¥éª¤3: è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
cd /var/www/blue-local
chmod +x scripts/deploy.sh
sudo ./scripts/deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… å®‰è£…ç³»ç»Ÿä¾èµ–
2. âœ… åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
3. âœ… é…ç½®MySQLæ•°æ®åº“
4. âœ… ç”Ÿæˆé…ç½®æ–‡ä»¶
5. âœ… é…ç½®Supervisorè¿›ç¨‹ç®¡ç†
6. âœ… é…ç½®Nginxåå‘ä»£ç†
7. âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡

### æ­¥éª¤4: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo supervisorctl status

# åº”è¯¥çœ‹åˆ°:
# blue-local-backend    RUNNING
# blue-local-cleanup    RUNNING

# æ£€æŸ¥Nginx
sudo systemctl status nginx

# è®¿é—®ç½‘ç«™
curl http://your-server-ip
```

## ğŸ”§ æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

### 1. å®‰è£…ä¾èµ–

```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-venv nginx supervisor mysql-server
```

### 2. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
sudo mkdir -p /var/www/blue-local
cd /var/www/blue-local
```

### 3. ä¸Šä¼ ä»£ç 

å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶ä¸Šä¼ åˆ° `/var/www/blue-local`

### 4. é…ç½®Pythonç¯å¢ƒ

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt
```

### 5. é…ç½®MySQL

```bash
sudo mysql -u root

# åœ¨MySQLä¸­æ‰§è¡Œï¼š
CREATE DATABASE blue_local_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'blue_local_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON blue_local_db.* TO 'blue_local_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 6. é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /var/www/blue-local/backend
cp .env.example .env
nano .env

# ç¼–è¾‘é…ç½®ï¼š
DATABASE_URL=mysql+pymysql://blue_local_user:your_password@localhost:3306/blue_local_db
SECRET_KEY=ç”Ÿæˆçš„éšæœºå¯†é’¥
DEBUG=False
```

ç”ŸæˆSECRET_KEY:
```bash
openssl rand -hex 32
```

### 7. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd /var/www/blue-local
python scripts/database/add_member_online_status.py
```

### 8. é…ç½®Supervisor

åˆ›å»º `/etc/supervisor/conf.d/blue-local-backend.conf`:
```ini
[program:blue-local-backend]
command=/var/www/blue-local/venv/bin/python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
directory=/var/www/blue-local
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blue-local-backend.log
environment=PYTHONPATH="/var/www/blue-local"
```

åˆ›å»º `/etc/supervisor/conf.d/blue-local-cleanup.conf`:
```ini
[program:blue-local-cleanup]
command=/var/www/blue-local/venv/bin/python backend/background_tasks.py
directory=/var/www/blue-local
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blue-local-cleanup.log
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start all
```

### 9. é…ç½®Nginx

åˆ›å»º `/etc/nginx/sites-available/blue-local`:
```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ”¹ä¸ºä½ çš„åŸŸåæˆ–IP

    client_max_body_size 20M;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/blue-local/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # APIä»£ç†
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocketä»£ç†
    location /socket.io {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }
}
```

å¯ç”¨é…ç½®ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/blue-local /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
```

### 10. è®¾ç½®æƒé™

```bash
sudo chown -R www-data:www-data /var/www/blue-local
sudo chmod -R 755 /var/www/blue-local
```

## ğŸ” éƒ¨ç½²éªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# SupervisoræœåŠ¡
sudo supervisorctl status

# NginxæœåŠ¡
sudo systemctl status nginx

# MySQLæœåŠ¡
sudo systemctl status mysql
```

### 2. æŸ¥çœ‹æ—¥å¿—

```bash
# åç«¯æ—¥å¿—
tail -f /var/log/blue-local-backend.log

# æ¸…ç†æœåŠ¡æ—¥å¿—
tail -f /var/log/blue-local-cleanup.log

# Nginxè®¿é—®æ—¥å¿—
tail -f /var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log
```

### 3. æµ‹è¯•API

```bash
# æµ‹è¯•APIæ–‡æ¡£
curl http://your-server-ip/api/docs

# æµ‹è¯•æ–‡ç« åˆ—è¡¨
curl http://your-server-ip/api/articles?skip=0&limit=10
```

## ğŸ” å®‰å…¨åŠ å›º

### 1. é…ç½®HTTPSï¼ˆLet's Encryptï¼‰

```bash
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 2. é…ç½®é˜²ç«å¢™

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 3. é™åˆ¶MySQLè¿œç¨‹è®¿é—®

ç¼–è¾‘ `/etc/mysql/mysql.conf.d/mysqld.cnf`:
```ini
bind-address = 127.0.0.1
```

é‡å¯MySQL:
```bash
sudo systemctl restart mysql
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. è®¾ç½®è‡ªåŠ¨å¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬ `/root/backup-blue-local.sh`:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/blue-local"
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u blue_local_user -p'your_password' blue_local_db | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/blue-local/uploads

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

æ·»åŠ åˆ°crontab:
```bash
sudo crontab -e
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /root/backup-blue-local.sh
```

### 2. æ—¥å¿—è½®è½¬

åˆ›å»º `/etc/logrotate.d/blue-local`:
```
/var/log/blue-local-*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    sharedscripts
    postrotate
        supervisorctl restart blue-local-backend blue-local-cleanup
    endscript
}
```

### 3. ç›‘æ§å‘Šè­¦

ä½¿ç”¨ç›‘æ§å·¥å…·ï¼ˆå¦‚Uptime Kuma, Prometheusç­‰ï¼‰ç›‘æ§ï¼š
- æœåŠ¡å¯ç”¨æ€§
- å“åº”æ—¶é—´
- ç£ç›˜ç©ºé—´
- å†…å­˜ä½¿ç”¨
- CPUè´Ÿè½½

## âš ï¸ å¸¸è§é—®é¢˜

### 1. æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo supervisorctl tail -f blue-local-backend

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8000

# æ£€æŸ¥Pythonè·¯å¾„
/var/www/blue-local/venv/bin/python --version
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u blue_local_user -p blue_local_db

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /var/www/blue-local/backend/.env
```

### 3. WebSocketè¿æ¥å¤±è´¥

- æ£€æŸ¥Nginxé…ç½®ä¸­çš„WebSocketéƒ¨åˆ†
- ç¡®è®¤é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢WebSocket
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

### 4. é™æ€æ–‡ä»¶404

```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /var/www/blue-local/frontend/dist

# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯æ—¥å¿—å†…å®¹
2. æœåŠ¡å™¨ç³»ç»Ÿç‰ˆæœ¬
3. éƒ¨ç½²æ­¥éª¤æè¿°
4. æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰
