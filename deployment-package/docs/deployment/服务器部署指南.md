# 🚀 Blue Local 服务器部署指南

## ✅ 部署前准备

### 1. 本地测试确认
在部署前，请确保以下功能都已在本地测试通过：

- [x] 用户注册和登录
- [x] 文章列表加载
- [x] 文章发布/编辑/删除
- [x] 同步观影房间创建
- [x] 视频播放同步（进度条延迟<1秒）
- [x] 房主拖动进度条成员同步
- [x] 聊天功能
- [x] 管理员功能

### 2. 服务器要求

**最低配置：**
- CPU: 2核
- 内存: 4GB
- 硬盘: 20GB SSD
- 系统: Ubuntu 20.04+ / CentOS 7+

**软件要求：**
- Python 3.9+
- MySQL 8.0+
- Nginx
- Node.js 18+ (仅构建时需要)

## 📦 方式一：一键部署（推荐）

### 步骤1: 打包项目

在Windows本地运行：
```bash
cd d:\Laragon\laragon\www\blue-local\scripts\deployment
package.bat
```

这会生成 `deploy-package` 目录，包含：
- 后端代码
- 前端构建产物
- 部署脚本
- 数据库迁移脚本

### 步骤2: 上传到服务器

```bash
# 压缩打包目录
7z a blue-local.zip deploy-package\*

# 上传到服务器（使用FTP/SFTP工具，或命令行）
scp blue-local.zip user@your-server:/tmp/

# SSH连接到服务器
ssh user@your-server

# 解压
cd /tmp
unzip blue-local.zip
sudo mv deploy-package /var/www/blue-local
```

### 步骤3: 运行部署脚本

```bash
cd /var/www/blue-local
chmod +x scripts/deploy.sh
sudo ./scripts/deploy.sh
```

脚本会自动：
1. ✅ 安装系统依赖
2. ✅ 创建Python虚拟环境
3. ✅ 配置MySQL数据库
4. ✅ 生成配置文件
5. ✅ 配置Supervisor进程管理
6. ✅ 配置Nginx反向代理
7. ✅ 启动所有服务

### 步骤4: 验证部署

```bash
# 检查服务状态
sudo supervisorctl status

# 应该看到:
# blue-local-backend    RUNNING
# blue-local-cleanup    RUNNING

# 检查Nginx
sudo systemctl status nginx

# 访问网站
curl http://your-server-ip
```

## 🔧 方式二：手动部署

### 1. 安装依赖

```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-venv nginx supervisor mysql-server
```

### 2. 创建项目目录

```bash
sudo mkdir -p /var/www/blue-local
cd /var/www/blue-local
```

### 3. 上传代码

将打包好的文件上传到 `/var/www/blue-local`

### 4. 配置Python环境

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt
```

### 5. 配置MySQL

```bash
sudo mysql -u root

# 在MySQL中执行：
CREATE DATABASE blue_local_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'blue_local_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON blue_local_db.* TO 'blue_local_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 6. 配置环境变量

```bash
cd /var/www/blue-local/backend
cp .env.example .env
nano .env

# 编辑配置：
DATABASE_URL=mysql+pymysql://blue_local_user:your_password@localhost:3306/blue_local_db
SECRET_KEY=生成的随机密钥
DEBUG=False
```

生成SECRET_KEY:
```bash
openssl rand -hex 32
```

### 7. 运行数据库迁移

```bash
cd /var/www/blue-local
python scripts/database/add_member_online_status.py
```

### 8. 配置Supervisor

创建 `/etc/supervisor/conf.d/blue-local-backend.conf`:
```ini
[program:blue-local-backend]
command=/var/www/blue-local/venv/bin/python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
directory=/var/www/blue-local
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blue-local-backend.log
environment=PYTHONPATH="/var/www/blue-local"
```

创建 `/etc/supervisor/conf.d/blue-local-cleanup.conf`:
```ini
[program:blue-local-cleanup]
command=/var/www/blue-local/venv/bin/python backend/background_tasks.py
directory=/var/www/blue-local
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blue-local-cleanup.log
```

启动服务：
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start all
```

### 9. 配置Nginx

创建 `/etc/nginx/sites-available/blue-local`:
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 改为你的域名或IP

    client_max_body_size 20M;

    # 前端静态文件
    location / {
        root /var/www/blue-local/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket代理
    location /socket.io {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/blue-local /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
```

### 10. 设置权限

```bash
sudo chown -R www-data:www-data /var/www/blue-local
sudo chmod -R 755 /var/www/blue-local
```

## 🔍 部署验证

### 1. 检查服务状态

```bash
# Supervisor服务
sudo supervisorctl status

# Nginx服务
sudo systemctl status nginx

# MySQL服务
sudo systemctl status mysql
```

### 2. 查看日志

```bash
# 后端日志
tail -f /var/log/blue-local-backend.log

# 清理服务日志
tail -f /var/log/blue-local-cleanup.log

# Nginx访问日志
tail -f /var/log/nginx/access.log

# Nginx错误日志
tail -f /var/log/nginx/error.log
```

### 3. 测试API

```bash
# 测试API文档
curl http://your-server-ip/api/docs

# 测试文章列表
curl http://your-server-ip/api/articles?skip=0&limit=10
```

## 🔐 安全加固

### 1. 配置HTTPS（Let's Encrypt）

```bash
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 2. 配置防火墙

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 3. 限制MySQL远程访问

编辑 `/etc/mysql/mysql.conf.d/mysqld.cnf`:
```ini
bind-address = 127.0.0.1
```

重启MySQL:
```bash
sudo systemctl restart mysql
```

## 📊 监控和维护

### 1. 设置自动备份

创建备份脚本 `/root/backup-blue-local.sh`:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/blue-local"
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u blue_local_user -p'your_password' blue_local_db | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# 备份上传文件（如果有）
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/blue-local/uploads

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

添加到crontab:
```bash
sudo crontab -e
# 每天凌晨2点备份
0 2 * * * /root/backup-blue-local.sh
```

### 2. 日志轮转

创建 `/etc/logrotate.d/blue-local`:
```
/var/log/blue-local-*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    sharedscripts
    postrotate
        supervisorctl restart blue-local-backend blue-local-cleanup
    endscript
}
```

### 3. 监控告警

使用监控工具（如Uptime Kuma, Prometheus等）监控：
- 服务可用性
- 响应时间
- 磁盘空间
- 内存使用
- CPU负载

## ⚠️ 常见问题

### 1. 服务无法启动

```bash
# 查看详细错误
sudo supervisorctl tail -f blue-local-backend

# 检查端口占用
sudo netstat -tlnp | grep 8000

# 检查Python路径
/var/www/blue-local/venv/bin/python --version
```

### 2. 数据库连接失败

```bash
# 测试数据库连接
mysql -u blue_local_user -p blue_local_db

# 检查配置文件
cat /var/www/blue-local/backend/.env
```

### 3. WebSocket连接失败

- 检查Nginx配置中的WebSocket部分
- 确认防火墙没有阻止WebSocket
- 查看浏览器控制台错误

### 4. 静态文件404

```bash
# 检查文件权限
ls -la /var/www/blue-local/frontend/dist

# 检查Nginx配置
sudo nginx -t
```

## 📞 技术支持

如遇到问题，请提供：
1. 错误日志内容
2. 服务器系统版本
3. 部署步骤描述
4. 浏览器控制台错误

---

**祝部署顺利！** 🎉
