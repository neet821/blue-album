# 多人同步观影功能 - 部署指南

## 📦 安装依赖

### 后端依赖

```bash
cd backend
pip install python-socketio
pip install python-multipart  # 用于文件上传(模式二)
```

或者更新 `requirements.txt`:

```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
python-dotenv==1.0.0
PyMySQL==1.1.0
python-socketio==5.10.0  # 新增
```

### 前端依赖

```bash
cd frontend
npm install socket.io-client
```

或者在 `package.json` 中添加:

```json
{
  "dependencies": {
    "socket.io-client": "^4.7.2"
  }
}
```

## 🗄️ 数据库迁移

运行以下SQL脚本创建新表:

```sql
-- 同步观影房间表
CREATE TABLE sync_rooms (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_code VARCHAR(20) UNIQUE NOT NULL,
    room_name VARCHAR(100) NOT NULL,
    host_user_id INT NOT NULL,
    control_mode VARCHAR(20) DEFAULT 'host_only' NOT NULL,
    mode VARCHAR(20) DEFAULT 'link' NOT NULL,
    video_source TEXT,
    video_hash VARCHAR(64),
    current_time INT DEFAULT 0,
    is_playing BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (host_user_id) REFERENCES users(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 房间成员表
CREATE TABLE sync_room_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_id INT NOT NULL,
    user_id INT NOT NULL,
    nickname VARCHAR(50),
    is_verified BOOLEAN DEFAULT TRUE,
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (room_id) REFERENCES sync_rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY unique_room_member (room_id, user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 房间聊天消息表
CREATE TABLE sync_room_messages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_id INT NOT NULL,
    user_id INT NOT NULL,
    message TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (room_id) REFERENCES sync_rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建索引优化查询
CREATE INDEX idx_room_code ON sync_rooms(room_code);
CREATE INDEX idx_room_active ON sync_rooms(is_active);
CREATE INDEX idx_room_member ON sync_room_members(room_id, user_id);
CREATE INDEX idx_message_room ON sync_room_messages(room_id);
```

## 🚀 启动服务

### 1. 启动后端服务

```bash
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 2. 启动前端服务

```bash
cd frontend
npm run dev
```

## 🔧 配置说明

### WebSocket 配置

在 `backend/websocket_server.py` 中:

```python
# 生产环境需要配置正确的 CORS 来源
sio = socketio.AsyncServer(
    async_mode='asgi',
    cors_allowed_origins=[
        'http://localhost:5173',
        'http://your-production-domain.com'
    ],
    logger=True,
    engineio_logger=True
)
```

### 前端 WebSocket 连接

在 `SyncRoomPlayer.vue` 中修改连接地址:

```javascript
// 开发环境
socket.value = io('http://localhost:8000/ws', {
  transports: ['websocket', 'polling']
});

// 生产环境
socket.value = io('https://your-domain.com/ws', {
  transports: ['websocket', 'polling']
});
```

## 📝 功能测试

### 1. 创建房间测试

1. 访问 `http://localhost:5173/tools/sync-room`
2. 点击"创建房间"
3. 填写房间信息:
   - 房间名称: 测试房间
   - 播放模式: 外部链接
   - 视频链接: `https://www.w3schools.com/html/mov_bbb.mp4`
   - 控制模式: 选择一种
4. 点击创建

### 2. 加入房间测试

1. 复制房间代码(6位)
2. 在另一个浏览器/隐身窗口登录另一个账号
3. 访问同步观影页面
4. 点击"加入房间"输入代码

### 3. 同步测试

- 测试播放/暂停同步
- 测试跳转同步
- 测试聊天功能
- 测试成员列表更新

## ⚠️ 常见问题

### 1. WebSocket 连接失败

**问题**: `WebSocket connection failed`

**解决**:
- 检查后端是否正常运行
- 检查端口 8000 是否被占用
- 检查防火墙设置

### 2. 视频无法播放

**问题**: 视频链接无法播放

**解决**:
- 确保视频链接是直链(以 .mp4, .webm 等结尾)
- 检查视频源是否支持 CORS
- 使用支持的视频格式

### 3. 同步延迟

**问题**: 播放器同步有延迟

**解决**:
- 检查网络连接
- 调整 `time_update` 节流时间(目前2秒)
- 调整同步误差阈值(目前2秒)

## 🔐 安全建议

1. **生产环境配置**:
   - 配置正确的 CORS 来源
   - 使用 HTTPS/WSS
   - 限制房间数量和成员数量

2. **消息验证**:
   - 消息长度限制(已实现: 500字符)
   - 敏感词过滤(待实现)
   - 频率限制(待实现)

3. **权限控制**:
   - 房间成员验证(已实现)
   - 控制权限检查(已实现)
   - 房主特权操作(已实现)

## 📈 性能优化建议

1. **使用 Redis 存储房间状态**(可选):
   - 减少数据库查询
   - 提高实时性
   - 支持横向扩展

2. **添加 CDN**(模式二):
   - 视频文件使用 CDN 加速
   - 减轻服务器带宽压力

3. **消息队列**(大规模):
   - 使用 RabbitMQ/Kafka 处理消息
   - 解耦 WebSocket 和业务逻辑

## 🎯 下一步开发

- [ ] 模式二-1: 房主上传视频功能
- [ ] 模式二-2: 本地视频哈希校验
- [ ] 房间密码保护
- [ ] 踢出成员功能
- [ ] 房间录制回放
- [ ] 表情/贴纸支持
- [ ] 语音聊天功能

## 📞 技术支持

如有问题请联系开发团队或查看完整文档。
