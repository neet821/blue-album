# 🐛 401 自动登出问题诊断

## 问题描述
- ❌ 删除 token 后刷新页面
- ❌ 既没有跳转到 /login
- ❌ 也没有显示提示

---

## 🔍 可能的原因

### 原因 1: 前端未加载新代码
浏览器可能缓存了旧的 `request.js` 文件。

**解决方案:**
1. 硬刷新页面: `Ctrl + Shift + R` (Windows) 或 `Cmd + Shift + R` (Mac)
2. 或清除缓存: DevTools → Network → Disable cache (勾选)

---

### 原因 2: 删除 token 后没有触发 API 请求
删除 token 后,如果页面没有发送 API 请求,拦截器就不会被触发。

**验证方法:**
1. 打开 DevTools → Network 标签
2. 筛选 `Fetch/XHR` 或输入 `api`
3. 删除 token 后刷新页面
4. **检查是否有 API 请求**

---

### 原因 3: 路由守卫拦截
可能在到达拦截器之前,路由守卫就阻止了请求。

**检查文件:** `frontend/src/router/index.js`

---

## 🧪 诊断步骤

### 步骤 1: 验证代码是否生效

在浏览器 Console 执行:
\`\`\`javascript
// 1. 检查 request.js 是否被加载
console.log('测试开始...');

// 2. 手动导入并测试(需要在组件内执行)
import('/src/utils/request.js').then(module => {
  console.log('✅ request.js 已加载');
  console.log('导出内容:', module);
});

// 3. 检查当前 token
console.log('当前 token:', localStorage.getItem('token'));
\`\`\`

---

### 步骤 2: 手动触发 401

在 Console 执行完整测试:
\`\`\`javascript
// 删除 token
localStorage.removeItem('token');
console.log('✅ Token 已删除');

// 手动发送请求触发 401
fetch('http://localhost:8000/api/categories', {
  headers: {
    'Authorization': 'Bearer invalid-token-12345'
  }
})
.then(response => {
  console.log('📡 响应状态:', response.status);
  if (response.status === 401) {
    console.log('✅ 后端返回 401');
  }
  return response.json();
})
.catch(error => {
  console.log('❌ 请求错误:', error);
});
\`\`\`

---

### 步骤 3: 检查是否有路由守卫

查看路由配置是否有 `beforeEach`:
\`\`\`javascript
// 在 router/index.js 中查找
router.beforeEach((to, from, next) => {
  // 如果这里有 token 检查,可能会干扰拦截器
})
\`\`\`

---

## 🛠️ 快速修复方案

### 方案 1: 添加路由守卫(推荐)

在 `router/index.js` 添加全局守卫:
\`\`\`javascript
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('token');
  
  // 需要认证的路由
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth);
  
  if (requiresAuth && !token) {
    alert('登录已过期,请重新登录');
    next('/login');
  } else {
    next();
  }
});
\`\`\`

---

### 方案 2: 在组件内检查

在 `LinkDashboard.vue` 的 `onMounted` 添加:
\`\`\`javascript
import { onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useAuthStore } from '@/stores/auth';

onMounted(() => {
  const authStore = useAuthStore();
  const router = useRouter();
  
  if (!authStore.token) {
    alert('请先登录');
    router.push('/login');
  }
});
\`\`\`

---

### 方案 3: 使用 axios 全局拦截器

确保所有 axios 请求都使用拦截器:
\`\`\`javascript
// main.js
import axios from 'axios';
import request from '@/utils/request';

// 全局替换 axios
app.config.globalProperties.$axios = request;
\`\`\`

---

## 🎯 立即测试

### 测试脚本 (在 Console 运行)

\`\`\`javascript
console.clear();
console.log('🧪 开始 401 测试...');

// 1. 保存当前 token
const oldToken = localStorage.getItem('token');
console.log('1️⃣ 当前 token:', oldToken ? oldToken.substring(0, 20) + '...' : 'null');

// 2. 删除 token
localStorage.removeItem('token');
console.log('2️⃣ Token 已删除');

// 3. 使用 fetch 发送请求(绕过 axios)
console.log('3️⃣ 发送 API 请求...');
fetch('http://localhost:8000/api/categories', {
  headers: {
    'Authorization': 'Bearer fake-token'
  }
})
.then(async response => {
  console.log('4️⃣ 收到响应, 状态码:', response.status);
  
  if (response.status === 401) {
    console.log('✅ 后端正确返回 401');
    console.log('⚠️ 但是 axios 拦截器没有触发!');
    console.log('💡 原因: fetch 请求不经过 axios 拦截器');
    console.log('');
    console.log('🔧 解决方法:');
    console.log('   需要刷新页面,让 LinkDashboard 组件发送 axios 请求');
    console.log('   或者检查路由守卫是否先拦截了');
  }
  
  const data = await response.json();
  console.log('5️⃣ 响应数据:', data);
})
.catch(error => {
  console.error('❌ 请求失败:', error);
});

// 4. 等待 2 秒后刷新页面
console.log('');
console.log('⏳ 2 秒后将刷新页面触发 axios 请求...');
setTimeout(() => {
  console.log('🔄 刷新页面...');
  location.reload();
}, 2000);
\`\`\`

---

## 📊 预期结果

### 如果代码正常工作:
\`\`\`
🧪 开始 401 测试...
1️⃣ 当前 token: eyJhbGciOiJIUzI1NiIsI...
2️⃣ Token 已删除
3️⃣ 发送 API 请求...
4️⃣ 收到响应, 状态码: 401
✅ 后端正确返回 401
⚠️ 但是 axios 拦截器没有触发!
💡 原因: fetch 请求不经过 axios 拦截器

⏳ 2 秒后将刷新页面触发 axios 请求...
🔄 刷新页面...

[页面刷新后]
🔒 检测到 401 错误,开始处理...
✅ Token 已清除
💬 显示登录过期提示
[弹出 alert: "登录已过期,请重新登录"]
🔄 准备跳转到登录页
✅ 已跳转到 /login
\`\`\`

---

## 🔄 下一步行动

**请执行以下操作:**

1. **硬刷新页面**: `Ctrl + Shift + R`

2. **在 Console 运行测试脚本** (上面的完整测试脚本)

3. **观察输出并截图**

4. **告诉我看到了什么**

特别注意:
- ✅ 是否看到 emoji 日志(🔒、✅、💬 等)
- ✅ 是否弹出 alert
- ✅ 是否跳转到 /login
- ❌ 是否有任何错误信息

---

**等待你的测试结果!** 🎯
