# 🚀 环境适配快速参考

## ✅ 已解决的环境差异问题

| 问题 | 解决方案 | 文件 |
|------|---------|------|
| 路径分隔符不同 | `Path()` 自动处理 | `backend/config.py` |
| 项目根目录不同 | `__file__` 自动检测 | `backend/config.py` |
| 数据库地址不同 | 环境变量 + 自动检测 | `.env` + `backend/config.py` |
| 服务器监听地址 | 根据环境自动选择 | `backend/config.py` |
| CORS 白名单不同 | 环境变量配置 | `.env` |
| 日志级别不同 | 开发DEBUG，生产INFO | `backend/config.py` |

---

## 📋 部署前必做 3 件事

### 1️⃣ 验证本地环境

```powershell
python scripts\deployment\validate-environment.py
```

### 2️⃣ 测试配置自适应

```powershell
python backend\config.py
```

### 3️⃣ 打包部署文件

```powershell
.\scripts\deployment\collect-deployment-files.ps1
Compress-Archive -Path deployment-package -DestinationPath blue-local-deploy.zip
```

---

## 🖥️ 服务器部署步骤

### 方案A: Docker（推荐）

```bash
# 1. 上传并解压
scp blue-local-deploy.zip user@server:/tmp/
ssh user@server
cd /var/www && unzip /tmp/blue-local-deploy.zip
mv deployment-package blue-local && cd blue-local

# 2. 配置环境
cp .env.docker.example .env.docker
nano .env.docker  # 修改密码！

# 3. 一键部署
chmod +x scripts/deployment/deploy-docker.sh
./scripts/deployment/deploy-docker.sh
```

### 方案B: Git 同步

```bash
# 1. 克隆仓库
git clone https://github.com/neet821/blue-album.git /var/www/blue-local
cd /var/www/blue-local

# 2. 拉取同步分支
./scripts/sync/pull-shared-branch.sh

# 3. 配置并部署
cp .env.example .env
nano .env  # 修改配置
./scripts/deployment/deploy-docker.sh
```

---

## 🔧 服务器必改配置

```bash
# .env 文件必改项
DB_PASSWORD=强密码123!              # ❌ 不要留空
SECRET_KEY=随机32字符以上            # ❌ 不要用默认值
CORS_ORIGINS=https://yourdomain.com  # ✅ 改成你的域名
```

---

## ✅ 部署成功标志

```bash
# 1. 配置自适应正确
python3 backend/config.py
# ✓ Environment: production
# ✓ Platform: Linux

# 2. 所有检查通过
python3 scripts/deployment/validate-environment.py
# ✓ All checks passed (10/10)

# 3. 服务正常运行
docker-compose ps
# ✓ All services Up

# 4. API 响应正常
curl http://localhost:8000/api/health
# {"status": "ok", "environment": "production"}
```

---

## 🔄 更新部署

### 本地推送

```powershell
git add .
git commit -m "update: xxx"
.\scripts\sync\push-shared-branch.ps1
```

### 服务器更新

```bash
cd /var/www/blue-local
./scripts/sync/pull-shared-branch.sh
docker-compose up -d --build
```

---

## 🆘 常见问题

| 问题 | 原因 | 解决 |
|------|------|------|
| 数据库连接失败 | .env 配置错误 | 检查 DB_HOST/USER/PASSWORD |
| CORS 错误 | 域名未配置 | 修改 CORS_ORIGINS |
| 端口被占用 | 服务冲突 | `lsof -i :8000` 查看占用 |
| 文件上传失败 | 权限不足 | `chown -R www-data uploads/` |
| 路径错误 | 硬编码路径 | 使用 `config.PROJECT_ROOT` |

---

## 📚 详细文档

- **完整指南**: `docs/deployment/环境适配完全指南.md`
- **部署说明**: `deployment-package/DEPLOYMENT_README.md`
- **配置文件**: `backend/config.py`
- **验证脚本**: `scripts/deployment/validate-environment.py`

---

**核心原则：写一次，到处运行！** 🎯
