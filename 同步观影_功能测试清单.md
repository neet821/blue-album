# ✅ 同步观影功能测试清单

## 🎯 测试目标
验证**进度条同步**和**聊天功能**是否正常工作

---

## 📋 测试前准备

### 1. 确认数据库表已创建 ✅
- ✅ `sync_rooms` 
- ✅ `sync_room_members`
- ✅ `sync_room_messages`

### 2. 确认服务运行中
```powershell
# 检查后端服务
Get-Process | Where-Object {$_.ProcessName -match "uvicorn|python"}

# 检查前端服务
Get-Process | Where-Object {$_.ProcessName -match "node"}
```

### 3. 重启服务（重要！）
```powershell
# 如果服务已运行,需要重启让后端加载新表
# 停止: Ctrl+C
# 启动: 
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

---

## 🧪 测试步骤

### 测试1: 创建房间
1. 打开浏览器访问: `http://localhost:3000` (或你的前端地址)
2. 登录系统
3. 找到**同步观影**菜单/按钮
4. 点击**创建房间**

**预期结果**:
- ✅ 能成功创建房间
- ✅ 看到房间代码(6位数字)
- ✅ 进入房间页面

**如果失败**:
- ❌ 按F12打开控制台查看错误
- ❌ 检查是否有红色错误信息

---

### 测试2: 视频播放控制
1. 在房间中上传或输入视频链接
2. 点击**播放**按钮

**预期结果**:
- ✅ 视频开始播放
- ✅ 控制台没有错误

3. 点击**暂停**按钮

**预期结果**:
- ✅ 视频暂停
- ✅ 其他成员(如果有)看到同步暂停

---

### 测试3: 进度条同步 ⭐
1. 拖动进度条到某个位置(如30秒处)

**预期结果**:
- ✅ 视频跳转到指定位置
- ✅ 控制台显示发送`time_update`事件
- ✅ 其他成员(如果有)视频同步跳转

**控制台应该看到**:
```
[Socket] 发送时间更新: {room_id: xxx, time: 30, user_id: xxx}
[Socket] 收到播放同步: {action: "seek", time: 30}
```

---

### 测试4: 聊天功能 ⭐
1. 在聊天框输入消息: "测试消息123"
2. 点击**发送**

**预期结果**:
- ✅ 消息立即显示在聊天区域
- ✅ 显示发送者昵称和时间
- ✅ 控制台显示发送`send_message`事件

**控制台应该看到**:
```
[Socket] 发送消息: {room_id: xxx, message: "测试消息123"}
[Socket] 收到新消息: {nickname: "xxx", message: "测试消息123", time: "..."}
```

---

### 测试5: 多人同步(可选)
1. 打开第二个浏览器窗口(或无痕模式)
2. 用另一个账号登录
3. 输入房间代码加入房间

**预期结果**:
- ✅ 第二个用户成功加入
- ✅ 房间成员列表更新
- ✅ 第一个用户的播放控制能同步到第二个用户
- ✅ 聊天消息双方都能看到

---

## 🔍 浏览器控制台诊断

按**F12**打开控制台,执行以下命令:

### 1. 检查Socket连接状态
```javascript
console.log("Socket连接:", window.$socket?.connected);
```
**预期**: `true`

### 2. 检查房间信息
```javascript
console.log("当前房间:", window.$currentRoom);
```
**预期**: 显示房间对象 `{room_id: xxx, room_code: "xxx", ...}`

### 3. 手动测试发送消息
```javascript
window.$socket.emit('send_message', {
    room_id: window.$currentRoom.room_id,
    user_id: window.$currentUser.id,
    message: "手动测试消息"
});
```
**预期**: 聊天区域显示消息

### 4. 手动测试播放控制
```javascript
window.$socket.emit('playback_control', {
    room_id: window.$currentRoom.room_id,
    user_id: window.$currentUser.id,
    action: 'play'
});
```
**预期**: 视频开始播放

### 5. 查看所有Socket事件监听
```javascript
console.log("监听的事件:", window.$socket?._callbacks);
```

---

## ✅ 成功标准

所有以下功能正常:
- [x] 创建房间成功
- [x] 视频播放/暂停正常
- [x] **进度条拖动后所有人同步** ⭐
- [x] **聊天消息发送和接收正常** ⭐
- [x] 成员加入/离开提示
- [x] 控制台无WebSocket错误

---

## ❌ 如果仍然失败

### 情况1: Socket连接失败
**症状**: 控制台显示 `Socket连接: false` 或 `undefined`

**解决**:
1. 检查后端是否运行在8000端口
   ```powershell
   netstat -ano | findstr :8000
   ```
2. 检查防火墙是否阻止
3. 查看后端日志是否有连接错误

### 情况2: 数据库错误
**症状**: 后端日志显示 `Table 'sync_rooms' doesn't exist`

**解决**:
1. 重新执行SQL创建表
2. 确认数据库名是`blue_local_db`
3. 重启后端服务

### 情况3: API调用失败
**症状**: 控制台显示 `404 Not Found` 或 `500 Internal Server Error`

**解决**:
1. 检查`backend/main.py`是否挂载了WebSocket
   ```python
   app.mount("/ws", sio_app)
   ```
2. 检查路由是否正确注册
3. 重启后端服务

### 情况4: 前端没有发送事件
**症状**: 点击按钮无反应,控制台无"发送XX"日志

**解决**:
1. 检查`SyncRoomPlayer.vue`中的Socket实例
2. 确认`window.$socket`已正确初始化
3. 刷新页面重新连接

---

## 📊 测试记录表

| 测试项 | 结果 | 备注 |
|-------|------|------|
| 创建房间 | ⬜ 通过 / ⬜ 失败 | |
| 视频播放控制 | ⬜ 通过 / ⬜ 失败 | |
| **进度条同步** | ⬜ 通过 / ⬜ 失败 | 主要问题 |
| **聊天功能** | ⬜ 通过 / ⬜ 失败 | 主要问题 |
| 多人同步 | ⬜ 通过 / ⬜ 失败 | 可选 |
| Socket连接 | ⬜ 正常 / ⬜ 异常 | |

---

## 🎯 下一步

### 如果测试全部通过 ✅
恭喜!功能已修复!可以正常使用同步观影了!

### 如果测试失败 ❌
请告诉我:
1. 哪个测试失败了?
2. 控制台的具体错误信息
3. 后端日志的错误(如果有)

我会根据具体问题继续帮你修复!

---

**开始测试吧!** 🚀
