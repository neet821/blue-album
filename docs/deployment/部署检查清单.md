# 服务器部署检查清单

## 📋 部署前检查

### 1. 代码状态检查
- [x] 所有相对导入已修复（适配 `backend.main:app` 启动方式）
- [x] 进度条同步优化完成（延迟<1秒）
- [x] 房主拖动进度条问题已修复
- [x] WebSocket服务器正常工作
- [ ] 本地测试所有功能正常

### 2. 配置文件检查
- [ ] 生产环境变量配置（`.env.production`）
- [ ] 数据库连接信息
- [ ] CORS跨域设置
- [ ] 静态文件路径配置

### 3. 依赖项检查
- [ ] `requirements.txt` 完整且最新
- [ ] `package.json` 依赖完整
- [ ] Python版本兼容性（建议3.9+）

### 4. 安全检查
- [ ] 数据库密码已设置
- [ ] JWT密钥已配置
- [ ] 生产环境禁用DEBUG模式
- [ ] API限流配置

## 🚀 部署步骤

### 阶段1: 准备工作

#### 1.1 后端配置
```bash
# 创建生产环境配置文件
cd backend
cp .env.example .env.production

# 编辑配置
# DATABASE_URL=mysql+pymysql://username:password@host:port/database
# SECRET_KEY=your-secret-key
# DEBUG=False
```

#### 1.2 前端构建
```bash
cd frontend
npm run build
# 构建产物在 dist/ 目录
```

### 阶段2: 服务器配置

#### 2.1 系统要求
- Ubuntu 20.04+ / CentOS 7+
- Python 3.9+
- Node.js 18+
- MySQL 8.0+
- Nginx

#### 2.2 安装依赖
```bash
# Python依赖
pip install -r requirements.txt

# 安装Supervisor（进程管理）
sudo apt-get install supervisor

# 安装Nginx
sudo apt-get install nginx
```

#### 2.3 数据库迁移
```bash
# 创建数据库
mysql -u root -p
CREATE DATABASE blue_local_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 运行迁移脚本
cd scripts/database
python add_member_online_status.py
```

### 阶段3: 服务配置

#### 3.1 Supervisor配置（后端进程管理）
创建 `/etc/supervisor/conf.d/blue-local-backend.conf`:
```ini
[program:blue-local-backend]
command=/path/to/venv/bin/python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
directory=/path/to/blue-local
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blue-local/backend.log
environment=PYTHONPATH="/path/to/blue-local"
```

#### 3.2 后台清理服务配置
创建 `/etc/supervisor/conf.d/blue-local-cleanup.conf`:
```ini
[program:blue-local-cleanup]
command=/path/to/venv/bin/python backend/background_tasks.py
directory=/path/to/blue-local
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blue-local/cleanup.log
```

#### 3.3 Nginx配置
创建 `/etc/nginx/sites-available/blue-local`:
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /path/to/blue-local/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket代理
    location /socket.io {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf)$ {
        root /path/to/blue-local/frontend/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 阶段4: 启动服务

```bash
# 重载Supervisor配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start blue-local-backend
sudo supervisorctl start blue-local-cleanup

# 启动Nginx
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

## 🔍 部署验证

### 1. 健康检查
```bash
# 检查后端服务
curl http://your-domain.com/api/docs

# 检查WebSocket
# 在浏览器控制台测试socket连接
```

### 2. 功能测试清单
- [ ] 用户注册/登录
- [ ] 文章列表加载
- [ ] 文章发布/编辑/删除
- [ ] 同步观影房间创建
- [ ] 房间成员加入/离开
- [ ] 视频播放控制同步
- [ ] 进度条同步（延迟<1秒）
- [ ] 聊天功能
- [ ] 管理员功能

### 3. 性能监控
```bash
# 查看后端日志
tail -f /var/log/blue-local/backend.log

# 查看清理服务日志
tail -f /var/log/blue-local/cleanup.log

# 监控进程状态
sudo supervisorctl status
```

## ⚠️ 常见问题

### 1. 数据库连接失败
- 检查MySQL服务是否运行
- 验证数据库用户权限
- 确认防火墙规则

### 2. WebSocket连接失败
- 检查Nginx WebSocket配置
- 验证防火墙端口开放
- 查看浏览器控制台错误

### 3. 静态文件404
- 确认前端构建完成
- 检查Nginx root路径
- 验证文件权限

## 📦 需要上传的文件

### 后端文件
```
backend/
├── *.py (所有Python文件)
├── requirements.txt
└── .env.production (手动创建)
```

### 前端文件
```
frontend/dist/ (构建后的文件)
```

### 配置文件
```
docs/deployment/
├── nginx.conf
├── supervisor-backend.conf
└── supervisor-cleanup.conf
```

### 数据库脚本
```
scripts/database/
└── add_member_online_status.py
```

## 🔐 安全建议

1. **使用HTTPS**
   - 配置SSL证书（Let's Encrypt）
   - 强制HTTPS重定向

2. **数据库安全**
   - 使用强密码
   - 限制数据库访问IP
   - 定期备份

3. **应用安全**
   - 更新所有依赖到最新版本
   - 配置防火墙规则
   - 启用日志记录

4. **监控告警**
   - 配置服务监控
   - 设置磁盘空间告警
   - 监控异常日志

## 📝 部署后TODO

- [ ] 配置自动备份
- [ ] 设置监控告警
- [ ] 配置CDN（如需要）
- [ ] 性能优化
- [ ] 日志轮转配置

---

**准备好部署了吗？** 请先完成本地测试，确保所有功能正常！
