# 部署后登录注册问题修复指南

## 🔍 问题诊断

### 问题描述
部署到服务器后，前端无法正常登录和注册，可能出现的错误：
- 网络错误：无法连接到后端API
- CORS错误：跨域请求被阻止
- 404错误：API端点不存在

### 根本原因
1. **前端硬编码API地址**：前端代码中硬编码了 `http://localhost:8000`
2. **CORS配置不完整**：生产环境的CORS origins未正确配置
3. **环境变量缺失**：服务器缺少必要的环境配置

## ✅ 修复方案

### 1. 前端API地址修复

#### 已修复的文件：
- `frontend/src/utils/api.js` - 新增API配置工具
- `frontend/src/stores/auth.js` - 使用新的API配置
- `frontend/src/views/PostsPage.vue` - 移除硬编码地址
- `frontend/src/views/PostDetailPage.vue` - 移除硬编码地址
- `frontend/src/views/AuthorPage.vue` - 移除硬编码地址

#### 修复原理：
```javascript
// ❌ 错误：硬编码地址
const response = await axios.post('http://localhost:8000/api/users/register', data);

// ✅ 正确：使用相对路径
const response = await apiClient.post(API_ENDPOINTS.REGISTER, data);
```

### 2. 后端CORS配置修复

#### 已修复的文件：
- `backend/main.py` - 动态加载CORS配置

#### 修复内容：
```python
# 从配置中获取CORS origins
from .config import config

# 添加配置中的CORS origins
if hasattr(config, 'CORS_ORIGINS'):
    origins.extend(config.CORS_ORIGINS)
```

### 3. 环境变量配置

#### 服务器端需要创建 `.env` 文件：

```bash
# 在服务器上创建配置文件
cd /var/www/blue-local/backend
nano .env
```

#### 配置内容：
```bash
# 数据库配置
DATABASE_URL=mysql+pymysql://blue_user:your_password@127.0.0.1:3306/blue_local_db
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=blue_user
DB_PASSWORD=your_strong_password
DB_NAME=blue_local_db

# JWT配置
SECRET_KEY=your-very-long-secret-key-at-least-32-characters
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# 服务器配置
HOST=0.0.0.0
PORT=8000

# CORS配置（重要！）
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com,http://yourdomain.com

# 环境类型
ENV=production

# 日志级别
LOG_LEVEL=INFO
```

## 🚀 部署步骤

### 1. 重新构建前端

```bash
# 在本地重新构建前端
cd frontend
npm run build
```

### 2. 上传修复后的代码

```bash
# 上传到服务器
scp -r frontend/dist user@server:/var/www/blue-local/frontend/
scp -r backend user@server:/var/www/blue-local/
```

### 3. 配置服务器环境

```bash
# SSH到服务器
ssh user@server

# 进入项目目录
cd /var/www/blue-local

# 创建环境配置文件
cp backend/.env.example backend/.env
nano backend/.env

# 设置文件权限
sudo chown -R www-data:www-data /var/www/blue-local
sudo chmod -R 755 /var/www/blue-local
```

### 4. 重启服务

```bash
# 如果使用Docker
docker-compose down
docker-compose up -d

# 如果使用Supervisor
sudo supervisorctl restart blue-local-backend

# 如果使用systemd
sudo systemctl restart blue-local
sudo systemctl restart nginx
```

## 🔍 验证修复

### 1. 检查API连接

```bash
# 测试API端点
curl http://your-server-ip/api/docs
curl http://your-server-ip/api/posts
```

### 2. 检查CORS配置

在浏览器开发者工具中查看：
- Network标签页：API请求是否成功
- Console标签页：是否有CORS错误

### 3. 测试登录注册

1. 访问网站首页
2. 点击"登录"或"注册"
3. 填写表单并提交
4. 检查是否成功

## 🛠️ 故障排除

### 问题1：仍然无法连接API

**检查项：**
- 服务器防火墙是否开放8000端口
- Nginx配置是否正确代理API请求
- 后端服务是否正常运行

**解决方案：**
```bash
# 检查端口
sudo netstat -tlnp | grep 8000

# 检查Nginx配置
sudo nginx -t
sudo systemctl restart nginx

# 检查后端日志
tail -f /var/log/blue-local-backend.log
```

### 问题2：CORS错误

**检查项：**
- `.env`文件中的CORS_ORIGINS配置
- 前端域名是否在CORS白名单中

**解决方案：**
```bash
# 检查CORS配置
cat backend/.env | grep CORS_ORIGINS

# 确保包含前端域名
CORS_ORIGINS=https://yourdomain.com,http://yourdomain.com
```

### 问题3：数据库连接失败

**检查项：**
- 数据库服务是否运行
- 数据库用户权限
- 连接字符串是否正确

**解决方案：**
```bash
# 检查MySQL状态
sudo systemctl status mysql

# 测试数据库连接
mysql -h 127.0.0.1 -u blue_user -p blue_local_db

# 检查.env配置
cat backend/.env | grep DB_
```

## 📋 检查清单

- [ ] 前端代码已更新（移除硬编码API地址）
- [ ] 后端CORS配置已更新
- [ ] 服务器环境变量已配置
- [ ] 数据库连接正常
- [ ] 前端已重新构建
- [ ] 服务已重启
- [ ] API端点可访问
- [ ] 登录注册功能正常

## 🎯 预防措施

1. **使用环境变量**：所有配置都通过环境变量管理
2. **相对路径**：前端使用相对路径而非绝对路径
3. **配置验证**：部署前验证所有配置
4. **日志监控**：定期检查服务日志

---

**修复完成后，登录注册功能应该可以正常工作了！** ✅
