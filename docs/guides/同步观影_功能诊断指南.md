# ğŸ” åŒæ­¥è§‚å½±åŠŸèƒ½è¯Šæ–­è„šæœ¬

## é—®é¢˜ï¼šè¿›åº¦æ¡åŒæ­¥å’ŒèŠå¤©åŠŸèƒ½æ— æ•ˆ

---

## ğŸ§ª è¯Šæ–­æ­¥éª¤

### 1ï¸âƒ£ æ£€æŸ¥æ•°æ®åº“è¡¨æ˜¯å¦åˆ›å»º

åœ¨ HeidiSQL æˆ– MySQL å®¢æˆ·ç«¯æ‰§è¡Œï¼š

```sql
USE blue_local;

-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SHOW TABLES LIKE 'sync_rooms%';

-- åº”è¯¥çœ‹åˆ°3ä¸ªè¡¨ï¼š
-- sync_rooms
-- sync_room_members  
-- sync_room_messages

-- æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE sync_rooms;
DESCRIBE sync_room_members;
DESCRIBE sync_room_messages;
```

**å¦‚æœè¡¨ä¸å­˜åœ¨**ï¼š
```sql
-- æ‰§è¡Œè¿ç§»è„šæœ¬
SOURCE D:\Laragon\laragon\www\blue-local\backend\migrations\sync_rooms_migration.sql;
```

---

### 2ï¸âƒ£ æ£€æŸ¥åç«¯ WebSocket æœåŠ¡

åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š`http://localhost:8000/ws/socket.io/`

**é¢„æœŸç»“æœ**ï¼š
- âœ… åº”è¯¥çœ‹åˆ° Socket.IO çš„å“åº”ï¼ˆä¸€ä¸²æ•°å­—æˆ– JSONï¼‰
- âŒ å¦‚æœçœ‹åˆ° 404ï¼Œè¯´æ˜ WebSocket æœªæŒ‚è½½

**æ£€æŸ¥åç«¯æ—¥å¿—**ï¼š
æŸ¥çœ‹è¿è¡Œ uvicorn çš„ç»ˆç«¯ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
INFO:engineio.server:Server initialized for asgi.
```

---

### 3ï¸âƒ£ æ£€æŸ¥å‰ç«¯ WebSocket è¿æ¥

**æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Consoleï¼‰**ï¼Œè¿›å…¥æ’­æ”¾å™¨é¡µé¢ååº”è¯¥çœ‹åˆ°ï¼š

```javascript
WebSocket è¿æ¥æˆåŠŸ
åŠ å…¥æˆ¿é—´æˆåŠŸ {room: {...}, members: [...]}
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°è¿™äº›æ—¥å¿—**ï¼š

æ£€æŸ¥ç½‘ç»œè¯·æ±‚ï¼ˆF12 â†’ Network â†’ WS æ ‡ç­¾ï¼‰ï¼š
- æŸ¥æ‰¾ `socket.io` è¿æ¥
- çŠ¶æ€åº”è¯¥æ˜¯ `101 Switching Protocols`
- å¦‚æœæ˜¯ `404`ï¼Œè¯´æ˜ WebSocket è·¯å¾„é”™è¯¯

---

### 4ï¸âƒ£ æµ‹è¯•è¿›åº¦æ¡åŒæ­¥

**æ­¥éª¤**ï¼š
1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼ˆæˆ–ä½¿ç”¨éšç§æ¨¡å¼ï¼‰
2. ç¬¬ä¸€ä¸ªçª—å£ï¼šåˆ›å»ºæˆ¿é—´
3. ç¬¬äºŒä¸ªçª—å£ï¼šä½¿ç”¨æˆ¿é—´ä»£ç åŠ å…¥
4. åœ¨ç¬¬ä¸€ä¸ªçª—å£ç‚¹å‡»æ’­æ”¾/æš‚åœ/æ‹–åŠ¨è¿›åº¦æ¡
5. è§‚å¯Ÿç¬¬äºŒä¸ªçª—å£æ˜¯å¦åŒæ­¥

**æ£€æŸ¥æ§åˆ¶å°**ï¼š
```javascript
// æˆ¿ä¸»æ“ä½œæ—¶åº”è¯¥çœ‹åˆ°
playback_control å‘é€: {action: 'play', room_id: 1, user_id: 1}

// æˆå‘˜ç«¯åº”è¯¥çœ‹åˆ°
playback_sync æ¥æ”¶: {action: 'play', ...}
```

---

### 5ï¸âƒ£ æµ‹è¯•èŠå¤©åŠŸèƒ½

**æ­¥éª¤**ï¼š
1. åœ¨èŠå¤©è¾“å…¥æ¡†è¾“å…¥æ¶ˆæ¯
2. ç‚¹å‡»å‘é€
3. æ£€æŸ¥æ˜¯å¦å‡ºç°åœ¨èŠå¤©åˆ—è¡¨

**æ£€æŸ¥æ§åˆ¶å°**ï¼š
```javascript
// å‘é€æ¶ˆæ¯æ—¶åº”è¯¥çœ‹åˆ°
send_message å‘é€: {message: 'ä½ å¥½', room_id: 1, user_id: 1, username: 'admin'}

// æ¥æ”¶æ¶ˆæ¯æ—¶åº”è¯¥çœ‹åˆ°
new_message æ¥æ”¶: {message: 'ä½ å¥½', username: 'admin', created_at: '2025-10-19...'}
```

---

## ğŸ› å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šWebSocket 404 é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
GET http://localhost:8000/ws/socket.io/?EIO=4&transport=polling 404
```

**åŸå› **ï¼šWebSocket æœªæ­£ç¡®æŒ‚è½½

**è§£å†³æ–¹æ³•**ï¼š
æ£€æŸ¥ `backend/main.py` æ–‡ä»¶æœ«å°¾æ˜¯å¦æœ‰ï¼š
```python
# å¿…é¡»åœ¨æ‰€æœ‰è·¯ç”±ä¹‹å
app.mount("/ws", socket_app)
```

**éªŒè¯**ï¼š
```bash
# åœ¨ç»ˆç«¯æµ‹è¯•
curl http://localhost:8000/ws/socket.io/
# åº”è¯¥è¿”å›ä¸€äº›æ•°æ®ï¼Œä¸æ˜¯ 404
```

---

### é—®é¢˜2ï¼šè·¨åŸŸ CORS é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
Access to XMLHttpRequest at 'http://localhost:8000' from origin 'http://localhost:5173' 
has been blocked by CORS policy
```

**è§£å†³æ–¹æ³•**ï¼š
æ£€æŸ¥ `backend/main.py` çš„ CORS é…ç½®ï¼š
```python
origins = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
    "http://localhost:5174",
    "http://127.0.0.1:5174",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

### é—®é¢˜3ï¼šç”¨æˆ· ID æˆ–ç”¨æˆ·åä¸º undefined

**ç—‡çŠ¶**ï¼š
```javascript
user_id: undefined
username: undefined
```

**åŸå› **ï¼šç”¨æˆ·æœªç™»å½•æˆ– authStore æœªæ­£ç¡®è·å–

**è§£å†³æ–¹æ³•**ï¼š

æ£€æŸ¥ `SyncRoomPlayer.vue` çš„ä»£ç ï¼š
```javascript
import { useAuthStore } from '../stores/auth';

const authStore = useAuthStore();
const currentUserId = computed(() => authStore.user?.id);
const currentUsername = computed(() => authStore.user?.username);
```

**éªŒè¯**ï¼š
åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼š
```javascript
// æ£€æŸ¥ localStorage
console.log(localStorage.getItem('auth-token'));

// æ£€æŸ¥ authStore
console.log(authStore.user);  // åº”è¯¥æœ‰ id å’Œ username
```

---

### é—®é¢˜4ï¼šè¿›åº¦æ¡ä¸åŒæ­¥

**å¯èƒ½åŸå› **ï¼š

1. **æƒé™é—®é¢˜**ï¼šéæˆ¿ä¸»åœ¨ `host_only` æ¨¡å¼ä¸‹æ— æ³•æ§åˆ¶
   ```javascript
   const canControl = computed(() => {
     return roomInfo.value.control_mode === 'all_members' || isHost.value;
   });
   ```

2. **`isUpdating` æ ‡å¿—æœªæ­£ç¡®é‡ç½®**
   ```javascript
   // æ£€æŸ¥æ˜¯å¦é™·å…¥ isUpdating = true çŠ¶æ€
   console.log('isUpdating:', isUpdating);
   ```

3. **WebSocket æœªè¿æ¥**
   ```javascript
   console.log('Socket çŠ¶æ€:', socket.value?.connected);
   ```

**è§£å†³æ–¹æ³•**ï¼š
åœ¨æ§åˆ¶å°æ‰‹åŠ¨æµ‹è¯•ï¼š
```javascript
// æ‰‹åŠ¨å‘é€æ’­æ”¾å‘½ä»¤
socket.value.emit('playback_control', {
  room_id: 1,
  user_id: 1,
  action: 'play'
});

// ç›‘å¬å“åº”
socket.value.on('playback_sync', (data) => {
  console.log('æ”¶åˆ°åŒæ­¥:', data);
});
```

---

### é—®é¢˜5ï¼šèŠå¤©æ¶ˆæ¯ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **ï¼š

1. **WebSocket äº‹ä»¶æœªç›‘å¬**
   ```javascript
   // æ£€æŸ¥æ˜¯å¦æ³¨å†Œäº† new_message ç›‘å¬
   socket.value.on('new_message', (data) => {
     messages.value.push(data);
     scrollToBottom();
   });
   ```

2. **æ¶ˆæ¯æœªä¿å­˜åˆ°æ•°æ®åº“**
   - æ£€æŸ¥åç«¯æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
   - æ£€æŸ¥ `sync_room_messages` è¡¨æ˜¯å¦æœ‰æ•°æ®

3. **æ»šåŠ¨åˆ°åº•éƒ¨å¤±è´¥**
   ```javascript
   const scrollToBottom = () => {
     nextTick(() => {
       if (chatMessages.value) {
         chatMessages.value.scrollTop = chatMessages.value.scrollHeight;
       }
     });
   };
   ```

**è§£å†³æ–¹æ³•**ï¼š
```javascript
// æ‰‹åŠ¨å‘é€æ¶ˆæ¯æµ‹è¯•
socket.value.emit('send_message', {
  room_id: 1,
  user_id: 1,
  username: 'test',
  message: 'æµ‹è¯•æ¶ˆæ¯'
});

// æ£€æŸ¥æ•°æ®åº“
// åœ¨ HeidiSQL æ‰§è¡Œï¼š
SELECT * FROM sync_room_messages ORDER BY created_at DESC LIMIT 10;
```

---

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤

### 1. é‡å¯åç«¯æœåŠ¡
```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰
cd d:\Laragon\laragon\www\blue-local
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
```
æŒ‰ Ctrl + Shift + Delete
é€‰æ‹©"ç¼“å­˜çš„å›¾åƒå’Œæ–‡ä»¶"
æ¸…é™¤
```

### 3. å¼ºåˆ¶åˆ·æ–°å‰ç«¯
```
æŒ‰ Ctrl + Shift + R
```

### 4. æ£€æŸ¥ä¾èµ–
```bash
# åç«¯
pip list | findstr socketio
# åº”è¯¥çœ‹åˆ°: python-socketio 5.10.0

# å‰ç«¯
cd frontend
npm list socket.io-client
# åº”è¯¥çœ‹åˆ°: socket.io-client@x.x.x
```

---

## ğŸ“Š å®Œæ•´çš„æµ‹è¯•æµç¨‹

### æµ‹è¯•è„šæœ¬ï¼ˆåœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼‰

```javascript
// ========== æµ‹è¯• WebSocket è¿æ¥ ==========
console.log('=== WebSocket è¯Šæ–­å¼€å§‹ ===');

// 1. æ£€æŸ¥ socket å¯¹è±¡
console.log('Socket å¯¹è±¡å­˜åœ¨:', !!socket.value);
console.log('Socket å·²è¿æ¥:', socket.value?.connected);
console.log('Socket ID:', socket.value?.id);

// 2. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
console.log('å½“å‰ç”¨æˆ· ID:', currentUserId.value);
console.log('å½“å‰ç”¨æˆ·å:', currentUsername.value);
console.log('æˆ¿é—´ ID:', roomId.value);

// 3. æ£€æŸ¥æˆ¿é—´ä¿¡æ¯
console.log('æˆ¿é—´ä¿¡æ¯:', roomInfo.value);
console.log('æ˜¯å¦æˆ¿ä¸»:', isHost.value);
console.log('å¯å¦æ§åˆ¶:', canControl.value);

// 4. æµ‹è¯•å‘é€æ’­æ”¾å‘½ä»¤
console.log('=== æµ‹è¯•æ’­æ”¾æ§åˆ¶ ===');
socket.value.emit('playback_control', {
  room_id: parseInt(roomId.value),
  user_id: currentUserId.value,
  action: 'play'
});

// 5. æµ‹è¯•å‘é€æ¶ˆæ¯
console.log('=== æµ‹è¯•èŠå¤©æ¶ˆæ¯ ===');
socket.value.emit('send_message', {
  room_id: parseInt(roomId.value),
  user_id: currentUserId.value,
  username: currentUsername.value,
  message: 'è¯Šæ–­æµ‹è¯•æ¶ˆæ¯'
});

console.log('=== WebSocket è¯Šæ–­å®Œæˆ ===');
```

---

## ğŸ¯ é¢„æœŸçš„æ­£å¸¸è¡Œä¸º

### è¿›åº¦æ¡åŒæ­¥
1. **æˆ¿ä¸»æ“ä½œ** â†’ å‘é€ WebSocket äº‹ä»¶ â†’ **æ‰€æœ‰æˆå‘˜åŒæ­¥**
2. **å»¶è¿Ÿ** < 1 ç§’
3. **è¯¯å·®é˜ˆå€¼** < 2 ç§’ï¼ˆè‡ªåŠ¨æ ¡æ­£ï¼‰

### èŠå¤©åŠŸèƒ½
1. **è¾“å…¥æ¶ˆæ¯** â†’ ç‚¹å‡»å‘é€ â†’ **ç«‹å³æ˜¾ç¤º**
2. **å…¶ä»–æˆå‘˜** â†’ åŒæ—¶æ”¶åˆ°æ¶ˆæ¯
3. **æ¶ˆæ¯ä¿å­˜** â†’ æ•°æ®åº“æŒä¹…åŒ–

---

## ğŸ“ æ£€æŸ¥æ¸…å•

è¿è¡ŒåŒæ­¥è§‚å½±åŠŸèƒ½å‰ï¼Œç¡®ä¿ï¼š

- [ ] âœ… æ•°æ®åº“è¡¨å·²åˆ›å»ºï¼ˆ`sync_rooms`, `sync_room_members`, `sync_room_messages`ï¼‰
- [ ] âœ… åç«¯æœåŠ¡è¿è¡Œä¸­ï¼ˆç«¯å£ 8000ï¼‰
- [ ] âœ… åç«¯æ—¥å¿—æ˜¾ç¤º "Server initialized for asgi."
- [ ] âœ… å‰ç«¯æœåŠ¡è¿è¡Œä¸­ï¼ˆç«¯å£ 5173ï¼‰
- [ ] âœ… ç”¨æˆ·å·²ç™»å½•ï¼ˆæœ‰ tokenï¼‰
- [ ] âœ… æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯
- [ ] âœ… WebSocket è¿æ¥æˆåŠŸï¼ˆçŠ¶æ€ 101ï¼‰
- [ ] âœ… å¯ä»¥åˆ›å»ºæˆ¿é—´
- [ ] âœ… å¯ä»¥åŠ å…¥æˆ¿é—´
- [ ] âœ… å¯ä»¥çœ‹åˆ°æˆå‘˜åˆ—è¡¨
- [ ] âœ… è§†é¢‘å¯ä»¥æ’­æ”¾
- [ ] âœ… æ§åˆ¶å°æœ‰ WebSocket æ—¥å¿—

---

## ğŸš‘ ç´§æ€¥ä¿®å¤æ­¥éª¤

å¦‚æœåŠŸèƒ½å®Œå…¨æ— æ•ˆï¼š

1. **åœæ­¢æ‰€æœ‰æœåŠ¡**
2. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```sql
   SOURCE D:\Laragon\laragon\www\blue-local\backend\migrations\sync_rooms_migration.sql;
   ```
3. **é‡å¯åç«¯**
   ```bash
   cd d:\Laragon\laragon\www\blue-local
   uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
   ```
4. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
5. **é‡å¯å‰ç«¯**ï¼ˆå¦‚æœéœ€è¦ï¼‰
6. **é‡æ–°ç™»å½•**
7. **åˆ›å»ºæ–°æˆ¿é—´æµ‹è¯•**

---

**ä¸‹ä¸€æ­¥**ï¼šè¯·å‘Šè¯‰æˆ‘åœ¨å“ªä¸€æ­¥é‡åˆ°äº†é—®é¢˜ï¼Œæˆ‘ä¼šæä¾›é’ˆå¯¹æ€§çš„è§£å†³æ–¹æ¡ˆã€‚
