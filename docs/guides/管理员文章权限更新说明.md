# 管理员文章权限更新说明

更新日期: 2025-10-16

---

## 📝 更新内容

根据需求，已将文章发布权限限制为仅管理员可用，同时确保所有用户都能在首页查看文章。

---

## ✅ 已完成的修改

### 1. 后端权限控制 (backend/main.py)

**创建文章 API 权限**:
```python
@app.post("/api/posts", ...)
def create_post(...):
    """创建文章（仅管理员）"""
    # 权限检查：仅管理员可以创建文章
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Only administrators can create posts")
    
    return crud.create_post(db, post, author_id=current_user.id)
```

- ✅ 创建文章：仅管理员
- ✅ 编辑文章：仅管理员
- ✅ 删除文章：仅管理员
- ✅ 查看文章：所有人（包括未登录用户）

---

### 2. 前端导航栏 (TheHeader.vue)

**"文章"链接仅管理员可见**:
```vue
<router-link v-if="isAdmin" to="/posts">文章</router-link>
```

新增计算属性:
```javascript
const isAdmin = computed(() => authStore.currentUser?.role === 'admin');
```

**效果**:
- ✅ 管理员：可见"文章"导航链接
- ✅ 普通用户：不显示"文章"导航链接
- ✅ 未登录用户：不显示"文章"导航链接

---

### 3. 文章列表页面 (PostsPage.vue)

**"写文章"按钮仅管理员可见**:
```vue
<router-link 
  v-if="authStore.currentUser?.role === 'admin'" 
  to="/posts/new" 
  class="btn-create"
>
  ✏️ 写文章
</router-link>
```

**效果**:
- ✅ 管理员：可见"写文章"按钮
- ✅ 普通用户：不显示按钮（即使直接访问 /posts 路由）

---

### 4. 文章编辑器 (PostEditorPage.vue)

**挂载时权限检查**:
```javascript
onMounted(() => {
  // 检查是否登录
  if (!authStore.isAuthenticated) {
    alert('请先登录');
    router.push('/login');
    return;
  }
  
  // 检查是否是管理员（只有管理员能创建/编辑文章）
  if (authStore.currentUser?.role !== 'admin') {
    alert('只有管理员可以发布文章');
    router.push('/');
    return;
  }
  
  fetchPost();
});
```

**效果**:
- ✅ 管理员：可以创建和编辑文章
- ✅ 普通用户：即使手动输入 URL 也会被重定向到首页
- ✅ 未登录用户：会被重定向到登录页

---

### 5. 文章详情页 (PostDetailPage.vue)

**编辑/删除按钮权限**:
```javascript
const canEdit = computed(() => {
  if (!authStore.isAuthenticated || !post.value) return false;
  // 仅管理员可以编辑/删除
  return authStore.currentUser?.role === 'admin';
});
```

**效果**:
- ✅ 管理员：可见编辑/删除按钮
- ✅ 普通用户：不显示编辑/删除按钮
- ✅ 所有人：都可以查看文章内容

---

### 6. 首页展示 (HomePage.vue)

**首页保持不变**:
```vue
<PostList />
```

**效果**:
- ✅ 所有用户（包括未登录）都能在首页看到文章列表
- ✅ 点击文章可查看详情
- ✅ 普通用户无法创建或编辑

---

## 🎯 权限矩阵

| 操作 | 管理员 | 普通用户 | 未登录用户 |
|-----|-------|---------|-----------|
| 首页查看文章列表 | ✅ | ✅ | ✅ |
| 查看文章详情 | ✅ | ✅ | ✅ |
| 看到"文章"导航链接 | ✅ | ❌ | ❌ |
| 访问 /posts 列表页 | ✅ | ✅* | ✅* |
| 创建文章 | ✅ | ❌ | ❌ |
| 编辑文章 | ✅ | ❌ | ❌ |
| 删除文章 | ✅ | ❌ | ❌ |

> *注：普通用户和未登录用户可以直接输入 URL 访问 /posts，但看不到"写文章"按钮

---

## 🧪 测试清单

### 管理员测试
- [ ] 登录管理员账号
- [ ] 首页能看到文章列表
- [ ] 导航栏显示"文章"链接
- [ ] 点击"文章"进入列表页
- [ ] 可见"写文章"按钮
- [ ] 能成功创建文章
- [ ] 能编辑和删除文章

### 普通用户测试
- [ ] 登录普通账号
- [ ] 首页能看到文章列表
- [ ] 导航栏**不显示**"文章"链接
- [ ] 可以点击首页文章查看详情
- [ ] 文章详情页**无**编辑/删除按钮
- [ ] 直接访问 /posts/new 会被拒绝并重定向

### 未登录测试
- [ ] 不登录状态
- [ ] 首页能看到文章列表
- [ ] 导航栏**不显示**"文章"链接
- [ ] 可以点击首页文章查看详情
- [ ] 文章详情页**无**编辑/删除按钮

---

## 📋 API 权限说明

| 端点 | 方法 | 权限要求 | 说明 |
|-----|------|---------|------|
| /api/posts | GET | 公开 | 获取文章列表 |
| /api/posts/{id} | GET | 公开 | 获取文章详情 |
| /api/posts | POST | 仅管理员 | 创建文章 |
| /api/posts/{id} | PUT | 仅管理员 | 更新文章 |
| /api/posts/{id} | DELETE | 仅管理员 | 删除文章 |

---

## 🔒 安全措施

1. **后端权限验证**
   - 所有创建/编辑/删除操作都在后端验证 role
   - 返回 403 Forbidden 给非管理员

2. **前端权限隐藏**
   - 按钮和链接根据角色显示/隐藏
   - 防止普通用户误操作

3. **路由守卫**
   - 编辑器页面挂载时检查权限
   - 非法访问自动重定向

4. **多层防护**
   - 即使前端被绕过，后端仍会拒绝非法请求
   - API 层面保证安全

---

## 结论

已成功实现仅管理员可发布文章的需求：
- ✅ 管理员拥有完整的文章管理权限
- ✅ 普通用户和访客可以浏览文章但无法修改
- ✅ 首页对所有人展示文章列表
- ✅ 导航栏根据角色动态显示

**建议下一步**: 
- 添加作者名称显示（目前只显示 author_id）
- 添加文章分类和标签功能
- 添加文章搜索功能
